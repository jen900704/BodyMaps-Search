<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CT Finder Â· Search + Viewer (Dark)</title>
    <style>
        :root {
            --bg: #0e1a2b;
            --panel: #12243b;
            --panel-soft: #132a45;
            --ink: #e8eff9;
            --sub: #a9b7cc;
            --line: #243a57;
            --brand: #2a6cff;
            --brand-ink: #fff;
            --accent: #febb02;
            --good: #16a34a;
            --bad: #ef4444;
            --control-h: 44px
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font: 14px/1.55 Inter, system-ui, Segoe UI, Arial;
            background: var(--bg);
            color: var(--ink)
        }

        .hero {
            background: #0a1b32;
            padding: 22px 16px 18px
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative
        }

        

        .segment {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border-right: 1px solid var(--line)
        }

        .segment:last-child {
            border-right: none
        }

        .segment label {
            font-weight: 800;
            color: var(--sub);
            min-width: 28px
        }

        .input,
        .fakeInput {
            width: 100%;
            height: var(--control-h);
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: var(--panel-soft);
            color: var(--ink)
        }

        .input::placeholder {
            color: #7e90ab
        }

        .inputWrap {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
}

.clearBtn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #9fb3d9;
  font-size: 20px;
  cursor: pointer;
  line-height: 1;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.clearBtn:hover {
  color: #fff;
}

.inputWrap:has(input:not(:placeholder-shown)) .clearBtn {
  opacity: 1;   /* æœ‰è¼¸å…¥æ™‚æ‰é¡¯ç¤º âœ• */
}


        .btnSearch {
            height: var(--control-h);
            align-self: center;
            border-radius: 10px;
            background: var(--brand);
            color: var(--brand-ink);
            border: none;
            font-weight: 900;
            padding: 0 22px;
            min-width: 132px;
            cursor: pointer;
            margin: 0 2px
        }

        .pop {
            position: relative
        }

        .popBtn {
            width: 100%;
            text-align: left;
            cursor: pointer
        }

        .popPanel {
            position: absolute;
            top: calc(var(--control-h) + 10px);
            left: 0;
            z-index: 50;
            display: none;
            width: 520px;
            max-width: 92vw;
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 12px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .35);
            padding: 14px
        }

        .pop.open .popPanel {
            display: block
        }

        .group {
            margin-bottom: 12px
        }

        .groupTitle {
            font-weight: 400;
            margin-bottom: 6px;
            color: var(--ink)
        }

        .chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .chip {
            padding: 6px 10px;
            border: 1px solid var(--line);
            border-radius: 999px;
            background: #0f223b;
            color: var(--ink);
            cursor: pointer
        }

        .chip.active {
            outline: 2px solid #6ea8ff
        }

        .main {
            max-width: 1200px;
            margin: 16px auto;
            display: grid;
            gap: 16px
        }

        @media(min-width:1100px) {
            .main {
                grid-template-columns: 300px 1fr
            }
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 14px
        }

        .filters {
            padding: 16px 18px;
            display: none;
            min-width: 340px; 
        }


        .filters.show {
            display: block
        }

        .secTitle {
            font-weight: 900;
            margin: 2px 0 8px
        }

        .fset {
            margin-bottom: 14px
        }

        .optRow {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0
        }

        .optRow input {
            transform: translateY(1px)
        }

        .count {
            color: var(--sub);
            font-size: 12px
        }

        .showMore {
            color: #8fb3ff;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0 2px;
            font-weight: 700
        }

        .badge {
            display: inline-block;
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
            color: var(--sub)
        }

        label {
            color: var(--ink)
        }

        /* Browse */
        .recBar {
            padding: 10px 12px;
            position: relative
        }

        .recTitle {
            font-weight: 900;
            margin: 4px 0 8px
        }

        .recViewport {
            position: relative
        }

        .recScroll {
            display: flex;
            gap: 12px;
            overflow: auto;
            padding-bottom: 8px;
            scroll-snap-type: x mandatory;
            scrollbar-width: none
        }

        .recScroll::-webkit-scrollbar {
            display: none
        }

        .recCard {
            min-width: 320px;
            scroll-snap-align: start;
            border: 1px solid var(--line);
            border-radius: 14px;
            background: var(--panel);
            overflow: hidden
        }

        .recThumb {
            width: 100%;
            aspect-ratio: 16/9;
            background: #0f223b;
            object-fit: cover
        }

        .recBody {
            padding: 10px
        }

        .recMeta {
            color: var(--sub);
            font-size: 12px
        }

        .btn {
            border: 1px solid var(--line);
            background: var(--panel-soft);
            color: var(--ink);
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px
        }

        .recCtrl {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: 1px solid var(--line);
            background: var(--panel-soft);
            color: var(--ink);
            border-radius: 999px;
            display: grid;
            place-items: center;
            cursor: pointer;
            opacity: .9
        }

        .recPrev {
            left: -6px
        }

        .recNext {
            right: -6px
        }

        .recPlay {
            position: absolute;
            right: 44px;
            top: -6px;
            width: 32px;
            height: 32px;
            border: 1px solid var(--line);
            background: var(--panel-soft);
            border-radius: 999px;
            display: grid;
            place-items: center;
            cursor: pointer;
            font-size: 14px
        }

        /* Results */
        .resultsHead {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px
        }

        .counter {
            font-weight: 900
        }

        .select {
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 8px 10px;
            background: var(--panel-soft);
            color: var(--ink)
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
            padding: 12px
        }

        .card {
            border: 1px solid var(--line);
            border-radius: 14px;
            background: var(--panel);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 6px 14px rgba(0, 0, 0, .25)
        }

        .card:hover {
            box-shadow: 0 10px 24px rgba(0, 0, 0, .35);
            transform: translateY(-1px)
        }

        .thumb {
            aspect-ratio: 4/3;
            width: 100%;
            object-fit: cover;
            background: #0f223b
        }

        .body {
            padding: 10px
        }

        .titleRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 4px 0 6px
        }

        .caseLink {
            font-weight: 900;
            font-size: 16px;
            color: #9ec5ff;
            text-decoration: none;
            letter-spacing: .2px
        }

        .caseLink:hover {
            text-decoration: underline
        }

        .keyRow {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin: 6px 0 2px
        }

        .kv {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            font-size: 13px
        }

        .kv .k {
    color: var(--sub);
    text-transform: capitalize;
    letter-spacing: .4px;
}


        .kv .v {
            font-weight: 900
        }

        .tag {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid transparent
        }

        .tag.ok {
            color: var(--good);
            background: rgba(22, 163, 74, .12);
            border-color: rgba(34, 197, 94, .25)
        }

        .tag.bad {
            color: var(--bad);
            background: rgba(239, 68, 68, .12);
            border-color: rgba(239, 68, 68, .25)
        }

        /* Preparing page */
        .prepPage {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 1200;
            pointer-events: auto
        }

        .prepPage.show {
            display: flex
        }

        .prepBox {
            text-align: center;
            color: #cfd7ff
        }

        .prepTitle {
            margin-top: 6px;
            font-weight: 800
        }

        .prepHint {
            margin-top: 4px;
            color: #8ea6ff
        }

        /* Viewer */
        .viewer {
            position: fixed;
            inset: 0;
            background: #000;
            color: #e8edf8;
            z-index: 100;
            display: none
        }

        .viewer.show {
            display: block
        }

        .viewer.compact .v-sidebar,
        .viewer.compact .v-card {
            display: none
        }

        .v-toolbar {
            position: fixed;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 10px;
            z-index: 1000;
            pointer-events: auto
        }

        .iconBtn {
            width: 40px;
            height: 40px;
            border: 1px solid #2b3146;
            background: #0f1324;
            color: #e8edf8;
            border-radius: 12px;
            display: grid;
            place-items: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .35)
        }

        .v-sidebar {
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            width: 260px;
            background: #0f1324;
            border-right: 1px solid #2b3146;
            padding: 12px;
            overflow: auto;
            z-index: 200
        }

        .v-sidebar h3 {
            margin: 2px 0 10px;
            font-size: 16px
        }

        .toggleAll {
            width: 100%;
            background: #161a2e;
            border: 1px solid #2b3146;
            border-radius: 10px;
            color: #e8edf8;
            padding: 8px 10px;
            margin-bottom: 8px;
            cursor: pointer
        }

        .v-card {
            position: fixed;
            top: 60px;
            left: 12px;
            width: 300px;
            background: #0f1324;
            border: 1px solid #2b3146;
            border-radius: 12px;
            padding: 10px;
            z-index: 300;
            max-height: calc(100vh - 96px);
            overflow: auto
        }

        .v-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            justify-content: space-between
        }

        .v-stage {
            margin-left: 260px;
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 12px;
            padding: 72px 16px 16px 276px
        }

        .viewer.compact .v-stage {
            margin-left: 0;
            padding: 12px
        }

        .v-view {
            position: relative;
            border: none;
            border-radius: 12px;
            background: #000;
            overflow: hidden
        }

        .v-view h4 {
            display: none
        }

        .v-view img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000
        }

        .center {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            color: #cfd7ff
        }

        .center .mini {
            width: 160px;
            height: 100px;
            background: #dcd7ce;
            border-radius: 10px;
            margin-bottom: 8px
        }

        .hidden {
            display: none !important
        }

        /* modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1300
        }

        .modal.show {
            display: flex
        }

        .modalBox {
            width: min(720px, 92vw);
            max-height: 80vh;
            overflow: auto;
            background: #0f1324;
            color: #e8edf8;
            border: 1px solid #2b3146;
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, .45)
        }

        .modalHead {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }

        .iconBtn.sm {
            width: 32px;
            height: 32px;
            border-radius: 10px
        }

        /* Class Map list style */
        .cm {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .cm-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 800;
            margin-bottom: 4px
        }

        .cm-group {
            border: 1px solid #2b3146;
            border-radius: 10px;
            background: #0f1324;
            overflow: hidden
        }

        .cm-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            cursor: default
        }

        .cm-row .chev {
            width: 18px;
            text-align: center;
            opacity: .9
        }

        .cm-row .title {
            flex: 1;
            font-weight: 700
        }

        .cm-row input[type=checkbox] {
            accent-color: #6ea8ff
        }

        .cm-items {
            padding: 8px 10px 10px 36px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 4px;
            max-height: 240px;
            overflow: auto;
            border-top: 1px solid #202844
        }

        .cm-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 4px;
            border-radius: 8px
        }

        .cm-item:hover {
            background: #121837
        }

        .cm-item input[type=checkbox] {
            accent-color: #6ea8ff;
            transform: translateY(1px)
        }

        .cm-item .name {
            font-size: 13px;
            letter-spacing: .2px
        }

        .cm-group.closed .cm-items {
            display: none
        }

        .v-sidebar::-webkit-scrollbar,
        .cm-items::-webkit-scrollbar {
            width: 10px;
            height: 10px
        }

        .v-sidebar::-webkit-scrollbar-thumb,
        .cm-items::-webkit-scrollbar-thumb {
            background: #1c243a;
            border-radius: 8px;
            border: 2px solid #0f1324
        }

        .v-sidebar::-webkit-scrollbar-track,
        .cm-items::-webkit-scrollbar-track {
            background: transparent
        }

        /* tools */
        .toolBtn {
            width: 44px;
            height: 44px;
            border: 1px solid #2b3146;
            background: #0f1324;
            color: #e8edf8;
            border-radius: 12px;
            display: grid;
            place-items: center;
            cursor: pointer
        }

        .toolBtn svg {
            width: 22px;
            height: 22px
        }

        /* === Unified typography === */
.groupTitle,
.optRow label,
.secTitle {
    font-weight: 400;
    font-size: 14px;
    color: var(--ink);
    text-transform: capitalize; /* é¦–å­—æ¯å¤§å¯« */
    letter-spacing: 0.2px;
}

.chip,
.btnSearch,
.recTitle,
.counter,
.kv .v {
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.1px;
}

.optRow label {
    display: flex;
    align-items: center;
    gap: 6px;
}
#tumorChips .chip[data-tumor="0"].active{
  background: rgba(22,163,74,.12);
  color: var(--good);
}
.recCtrl[disabled] { opacity: .45; cursor: not-allowed; }
/* === UI ä¿®æ­£ 2025-10-16 === */

/* Hero section å–®å±¤æ·±è—èƒŒæ™¯ */
.hero {
    background: var(--bg);
    padding: 22px 16px 18px;
}

/* Search Rail èª¿æ•´ï¼šSearch æŒ‰éˆ•å›ºå®šåœ¨å³é‚Š */
.searchRail {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--panel);
    border-radius: 14px;
    padding: 6px 10px;
    box-shadow: 0 0 0 3px var(--accent) inset;
}

/* è®“ ID èˆ‡ STA éƒ¨åˆ†æ’æ»¿ */
.searchRail .segment {
    flex: 1;
    border-right: none;
    padding: 4px 6px;
}

/* Search æŒ‰éˆ•å³å´å›ºå®š */
.searchRail .btnSearch {
    margin-left: auto;
    height: var(--control-h);
    border-radius: 10px;
    background: var(--brand);
    color: var(--brand-ink);
    border: none;
    font-weight: 900;
    padding: 0 24px;
    cursor: pointer;
}

/* Tumor chips ç„¡å¤–æ¡†æ‰å¹³é¢¨æ ¼ */
#tumorChips .chip[data-tumor="1"],
#tumorChips .chip[data-tumor="0"] {
    background: transparent;
    border: none;
    color: var(--ink);
    font-weight: 600;
    cursor: pointer;
}

#tumorChips .chip[data-tumor="1"].active {
    color: var(--bad);
}
#tumorChips .chip[data-tumor="0"].active {
    color: var(--good);
}
/* ä»»ä½•æ²’æ‰“é–‹çš„è¦†è“‹å±¤éƒ½å¾¹åº•é—œæ‰ */
#prepPage:not(.show),
.modal[aria-hidden="true"] {
  display: none !important;
  pointer-events: none !important;
  opacity: 0 !important;
}

/* åªä¿ç•™æœ€æ·±çš„æ·±è—è‰²èƒŒæ™¯ï¼Œä¸è¦å¤šå±¤ */
.pageBgTop, .hero::before, .hero::after {
  display: none !important;
}

/* ç¢ºä¿ popPanel åªè“‹åœ¨ STA å€å¡Šå…§ï¼Œä¸æœƒæ“‹åˆ°å³å´ Search æŒ‰éˆ• */
.searchRail { position: relative; }
.pop { position: relative; }
.pop .popPanel {
  position: absolute;
  z-index: 1000;
  pointer-events: auto;
}

/* é¿å…æœ‰æ±è¥¿å…¨å¯¬è“‹ä½é»ƒæ¡†(ä¿éšª) */
.hero, .hero .container, .searchRail {
  z-index: 1;
}
/* --- Tumor/No tumor ç•¶æˆæŒ‰éˆ•ï¼ˆpillï¼‰ --- */
#tumorChips .chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,.35);
  background: rgba(12,26,45,.35);
  color: #e8eff9;
  font-weight: 600;
  cursor: pointer;
  box-shadow: none;
  transition: background .2s ease, border-color .2s ease, color .2s ease, transform .02s ease;
  user-select: none;
}
#tumorChips .chip:hover {
  background: rgba(34,73,130,.35);
  border-color: rgba(148,163,184,.6);
}
#tumorChips .chip.active {
  background: rgba(40,90,150,.9);
  border-color: rgba(148,163,184,.9);
  color: #fff;
}
#tumorChips .chip:active { transform: translateY(0); } /* ä¸ç¸®æ”¾ï¼Œé¿å…ã€Œå½ˆè·³ã€æ„Ÿ */


/* =====================================================
   2) Tumor / No tumor æ–‡å­—ï¼ˆResults + Browseï¼‰
   ===================================================== */
.tag.ok,
.tag.bad{
  background: none !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
  font-weight: 700;
  font-size: 1.08rem;             /* å†å¤§ä¸€é» */
  letter-spacing: .2px;
  line-height: 1.2;
}
.tag.ok{  color: #22c55e !important; }   /* ç¶  */
.tag.bad{ color: #f87171 !important; }   /* ç´… */

/* =====================================================
   3) Results / Browse ç¸®åœ– â†’ æ­£æ–¹å½¢ + ç½®ä¸­è£åˆ‡
   ===================================================== */
.card .thumb,
.recScroll .card .thumb,
.recScroll .recThumb{
  width: 100%;
  aspect-ratio: 1 / 1;            /* âœ… æ­£æ–¹å½¢ */
  object-fit: cover;
  display: block;
  background: #0f223b;
  border-radius: 12px;            /* å¡ç‰‡æ•´é«”åœ“è§’ä¸€è‡´ */
}

/* =====================================================
   4) Browseï¼šèˆ‡ Results å¡ç‰‡çµ±ä¸€ã€æ°´å¹³æ»‘å‹•ç©©å®š
   ===================================================== */
.recViewport{
  position: relative;             /* ä¾›æ§åˆ¶éµå®šä½ */
}
.recScroll{
  display: flex;
  gap: 12px;
  overflow-x: auto;
  overflow-y: hidden;             /* âœ… é—œæ‰å‚ç›´æ²å‹•ï¼Œé¿å…é«˜åº¦è·³å‹• */
  scroll-behavior: smooth;
  scrollbar-gutter: stable both-edges; /* âœ… æ²è»¸æºæ§½å›ºå®šï¼Œä¸æŠ–å‹• */
  padding: 2px 2px 8px;
}
.recScroll .card{
  flex: 0 0 340px;
  min-width: 340px;
  position: relative;
  z-index: 1;
}

/* =====================================================
   5) Browse æ§åˆ¶éµï¼šå›ºå®šåœ¨æœ€ä¸Šå±¤ä¸”ä¸è·³å‹•
   ===================================================== */
#recPrev, #recNext, #recPlay{
  position: absolute !important;
  z-index: 9999 !important;       /* âœ… æ°¸é åœ¨æœ€ä¸Šå±¤ */
  background: rgba(12,26,45,.85);
  border: none;
  color: #e8eff9;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,.25);
  transition: background .2s ease, opacity .12s ease;  /* â† ä¸å†ç¸®æ”¾ */
  pointer-events: auto;
}
#recPrev:hover, #recNext:hover, #recPlay:hover{
  background: rgba(34,73,130,.95);
}
#recPrev:active, #recNext:active, #recPlay:active{
  opacity: .9;                    /* â† å–ä»£ transform: scale(.96) */
}

/* ä½ç½®ï¼šå·¦å³ç½®ä¸­ï¼Œæš«åœæ”¾å³ä¸Šè§’ */
#recPrev{ left: 8px;  top: 50%; transform: translateY(-50%); }
#recNext{ right: 8px; top: 50%; transform: translateY(-50%); }
#recPlay{ right: 12px; top: 10px;  transform: none; }
/* è®“æœå°‹å€èˆ‡å½ˆçª—æ°¸é åœ¨æœ€ä¸Šå±¤ */
.hero,
.searchRail,
.pop { position: relative; z-index: 10010; }

/* å½ˆå‡ºé¢æ¿æœ¬èº«å±¤ç´šå†å¢Šé«˜ */
.pop .popPanel { position: absolute; z-index: 10020; }

/* ç¢ºä¿å½ˆçª—ä¸è¢«çˆ¶å±¤è£åˆ‡ */
.hero, .searchRail, .pop { overflow: visible; }

/* é™ä½ Browse æ§åˆ¶éµå±¤ç´šï¼ˆä»é«˜æ–¼å¡ç‰‡å³å¯ï¼‰*/
#recPrev, #recNext, #recPlay { z-index: 9000 !important; }

/* ç¢ºä¿ Viewer æ°¸é åœ¨æœ€ä¸Šå±¤ */
#viewer {
  position: fixed;       /* è„«é›¢æ–‡æµï¼Œè¦†è“‹æ•´å€‹è¦–çª— */
  inset: 0;              /* top/right/bottom/left = 0 */
  z-index: 10000;        /* æ¯”ä»»ä½• header/toolbar éƒ½é«˜ */
  display: none;         /* ä½ åŸæœ¬ç”¨ .show æ§åˆ¶é¡¯ç¤ºå³å¯ */
}
#viewer.show { display: block; }

/* æº–å‚™ä¸­é®ç½©è‹¥æœ‰ç”¨åˆ°ï¼Œä¹Ÿè¦æ›´é«˜å±¤ç´š */
#prepPage, #reportModal {
  position: fixed;
  inset: 0;
  z-index: 10001;        /* è“‹é viewer å…§å®¹ */
}

/* è‹¥æœ‰é ‚éƒ¨å›ºå®š/é»è‘—çš„ headerï¼Œçµ¦å®ƒè¼ƒä½å±¤ç´š */
#masthead, .topbar, .searchBarWrap {
  z-index: 100;          /* ä½æ–¼ viewer */
}

/* é¿å… header åœ¨ viewer é–‹å•Ÿæ™‚å¯é»é¸/èšç„¦ */
body.viewer-open #masthead,
body.viewer-open .topbar,
body.viewer-open .searchBarWrap {
  pointer-events: none;  /* é˜²æ­¢é»åˆ°èƒŒå¾Œçš„æœå°‹åˆ— */
}

.searchBarWrap.hidden,
#masthead.hidden { display: none !important; }
/* Viewer é–‹å•Ÿæ™‚ï¼Œæ•´å€‹æœå°‹åˆ—éš±è— */
body.viewer-open .hero { 
  display: none !important; 
}

/* å®‰å…¨ï¼šæŠŠä»»ä½•ç½®é ‚å·¥å…·åˆ—å±¤ç´šå£“ä½ï¼Œviewer æ°¸é åœ¨æœ€ä¸Šå±¤ */
#masthead, .topbar, .searchBarWrap { z-index: 100; }
#viewer { position: fixed; inset: 0; z-index: 10000; }
/* å°å­—æç¤ºï¼šMulti-Select */
.hint {
  display: inline-block;
  margin-left: .5rem;
  padding: 2px 6px;
  font-size: 12px;
  letter-spacing: .2px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  color: #aab7c7;
  vertical-align: middle;
}

/* è®“ chips çœ‹èµ·ä¾†ã€Œå¹³é¢ã€ä¸åƒæŒ‰éˆ•ã€ */
.chipArea.flat .chip {
  border: 0 !important;
  box-shadow: none !important;
  background: transparent !important;
  color: #c9d6e2;
  padding: 6px 12px;
  line-height: 1.1;
  transition: background .15s ease, color .15s ease;
}
.chipArea.flat .chip:hover {
  background: rgba(255,255,255,.06) !important;
}
.chipArea.flat .chip.active {
  background: rgba(59,130,246,.25) !important; /* é¡ Tumor çš„é¸å–æ„Ÿ */
  color: #e6f0ff !important;
}
/* è®“æ•´æ¢è®Šæˆ flexï¼Œç¬¬ä¸‰å€‹å­ç¯€é»ï¼ˆSearchï¼‰è‡ªå‹•é å³ */
.searchRail {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* å…©å€‹ segment å„è‡ªæ’æ»¿å¯ç”¨å¯¬åº¦ï¼Œä½†ä¸æŠŠæŒ‰éˆ•æ“ èµ° */
.searchRail > .segment {
  flex: 1 1 0;
  min-width: 0;            /* é˜²æ­¢å…§éƒ¨å…§å®¹æŠŠæŒ‰éˆ•æ“ å‡ºç•«é¢ */
  border-right: none;      /* å·²æ”¹æˆ flexï¼Œä¸éœ€è¦åˆ†éš”ç·š */
  padding: 4px 6px;
}

/* Search æŒ‰éˆ•å›ºå®šé æœ€å³é‚Š */
.searchRail > .btnSearch {
  margin-left: auto;       /* é—œéµï¼šæŠŠæŒ‰éˆ•æ¨åˆ°æœ€å³ */
}

/* è®“ popPanel ä»¥ç¬¬äºŒæ®µç‚ºå®šä½å®¹å™¨ï¼Œä¸æœƒè“‹åˆ°å³é‚ŠæŒ‰éˆ• */
#segSTA { position: relative; }
#segSTA .popPanel {
  left: 0;                 /* ä¹Ÿå¯ä»¥æ”¹æˆ right:0; è¦–ä½ è¦é å·¦/é å³è²¼é½Š */
  right: auto;
}

#cards.centerOne{
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 24px;
}
#cards.centerOne .card{
  max-width: 560px;
  width: 100%;
}
.optRow.disabled { opacity: .45; pointer-events: none; }
.optRow.disabled .count { opacity: .8; }
    </style>
</head>

<body>
<button id="homeBtn" class="home-btn" title="Home" aria-label="Home">
  <!-- å…§åµŒ SVGï¼Œä¸ç”¨é¡å¤–åœ–æª” -->
  <svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor" aria-hidden="true">
    <path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/>
  </svg>
</button>

<!-- âœ… Search Section -->
<section class="hero">
  <div class="container">
    <div class="searchRail">
      <!-- ID -->
      <div class="segment pop" id="popID">
        <label>ID</label>
        <div class="inputWrap">
          <input id="q" class="input popBtn" placeholder="Search Case ID or keywordâ€¦" autocomplete="off">
          <button id="clearBtn" class="clearBtn" title="Clear" aria-label="Clear">Ã—</button>
        </div>

        <div class="popPanel" style="width:520px">
          <div class="group">
            <div class="groupTitle">Recommended IDs</div>
            <div id="idReco" class="chips"></div>
          </div>
          <div class="group">
            <div class="groupTitle">Recently viewed</div>
            <div id="idRecent" class="chips">
              <span class="recMeta">No recent</span>
            </div>
          </div>
        </div>
      </div>


      <!-- STA -->
      <div class="segment pop" id="popSTA">
        <button class="fakeInput popBtn" type="button">
          <span id="staSummary">Any tumor Â· Any sex Â· Any age</span>
        </button>

        <div class="popPanel" style="max-width:560px">
          <div class="group">
            <div class="groupTitle">Tumor</div>
            <div id="tumorChips" class="chips">
              <button class="chip" data-tumor="">Any</button>
              <button class="chip flat" data-tumor="1">Tumor</button>
              <button class="chip flat" data-tumor="0">No tumor</button>
            </div>
          </div>

          <div class="group">
            <div class="groupTitle">Sex <span class="hint">Multi-Select</span></div>
            <div id="sexChips" class="chipArea flat">
              <button class="chip" data-sex="">Any</button>
              <button class="chip" data-sex="M">Male</button>
              <button class="chip" data-sex="F">Female</button>
              <button class="chip" data-sex="U">Unknown</button>
            </div>
          </div>

          <div class="group">
            <div class="groupTitle">Age <span class="hint">Multi-Select</span></div>
            <div id="ageChips" class="chipArea flat"></div>
          </div>
        </div> <!-- /popPanel -->
      </div> <!-- /segment popSTA -->

      <!-- âœ… Search button fixed at right -->
      <button id="searchBtn" class="btnSearch" type="button">Search</button>
    </div> <!-- /.searchRail -->
  </div>
</section>

<style>
/* === ä¿®æ­£ç‰ˆ Search Rail æ¨£å¼ === */

/* Flex ä½ˆå±€è®“ Search å›ºå®šå³å´ */
.searchRail {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--panel);
  border-radius: 14px;
  padding: 6px 10px;
  box-shadow: 0 0 0 3px var(--accent) inset;
  position: relative;
  overflow: visible;
}

/* Segment æ’æ»¿ */
.searchRail > .segment {
  flex: 1 1 0;
  min-width: 0;
  border-right: none;
  padding: 4px 6px;
}

/* âœ… Search æŒ‰éˆ•é æœ€å³é‚Š */
.searchRail > .btnSearch {
  margin-left: auto;
  height: var(--control-h);
  border-radius: 10px;
  background: var(--brand);
  color: var(--brand-ink);
  border: none;
  font-weight: 900;
  padding: 0 24px;
  cursor: pointer;
}

/* PopPanel å®šä½æ–¼ STA ä¸‹æ–¹ï¼Œä¸è¦†è“‹ Search */
#popSTA { position: relative; }
#popSTA .popPanel {
  position: absolute;
  top: calc(var(--control-h) + 10px);
  left: 0;
  z-index: 1000;
  pointer-events: auto;
}

/* Hero ä¿ç•™æœ€ä¸Šå±¤ */
.hero, .hero .container, .searchRail {
  z-index: 10;
  position: relative;
}

/* ç¢ºä¿æ¨£å¼ä¸€è‡´ */
.fakeInput {
  width: 100%;
  height: var(--control-h);
  display: flex;
  align-items: center;
  padding: 10px 12px;
  border-radius: 10px;
  background: var(--panel-soft);
  color: var(--ink);
  border: 1px solid var(--line);
  cursor: pointer;
}

.btnSearch:hover {
  background: #3b7aff;
  transition: background .2s ease;
}
#cards.centerOne{
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 24px;
}
#cards.centerOne .card{
  max-width: 560px;
  width: 100%;
}
.home-btn{
  position: fixed; top: 25px; left: 40px;
  width: 44px; height: 44px;
  display: grid; place-items: center;
  background: #2a3342; color: #e6ecff;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(0,0,0,.25);
  cursor: pointer; z-index: 9999;
}
.home-btn:hover{ filter: brightness(1.08); }
.home-btn:active{ transform: translateY(1px); }

</style>
<style>
  /* === è®“æ•´é«”å·¦å³ç©ºç™½è®Šçª„ï¼ŒAdvanced / Results åŒæ­¥è®Šå¯¬ === */
  .main, .content, .twoCols {
    display: grid;
    grid-template-columns: 380px minmax(0, 1fr); /* å·¦å´ Advanced 380pxï¼Œå¯ä¾éœ€è¦æ”¹ */
    gap: 20px; /* ä¸­é–“è·é›¢ç¨å¾®ç¸®å° */
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
    padding-left: 20px;   /* å·¦å³å¤–é‚Šç•Œéƒ½ç¸®å° */
    padding-right: 20px;
  }

  /* Advancedï¼ˆå·¦å´ï¼‰ */
  #filters, .facetPanel {
    width: 100%;
    max-width: 400px;
  }

  /* Resultsï¼ˆå³å´å¡ç‰‡å€ï¼‰ */
  #resultsPanel {
    width: 100%;
    margin-left: 0;
  }

 /* å¡ç‰‡å€ï¼šæ¡Œæ©Ÿ 3 æ¬„ã€å¹³æ¿ 2 æ¬„ã€æ‰‹æ©Ÿ 1 æ¬„ï¼›æ”¯æ´å–®ç­†ç½®ä¸­ */
#cards{
  display: grid;
  grid-template-columns: repeat(3, minmax(320px, 1fr));
  gap: 24px;
  align-items: stretch;
}

/* çª„ä¸€é»çš„è¢å¹•ï¼š2 æ¬„ï¼ˆå¤šç­†çµæœæ™‚ä»ç”¨ gridï¼‰ */
@media (max-width: 1200px){
  #cards{ grid-template-columns: repeat(2, minmax(300px, 1fr)); gap: 20px; }
}

/* æ‰‹æ©Ÿï¼š1 æ¬„ */
@media (max-width: 700px){
  #cards{ grid-template-columns: 1fr; gap: 16px; }
}

/* ç¸®åœ–é«˜åº¦ */
.card .thumb{
  height: 320px;
  object-fit: cover;
}

/* å¯¬è¢å¹•ï¼šå·¦å³å…§è· & å¡ç‰‡ç¨å¾®åŠ å¤§ */
@media (min-width: 1600px){
  .main, .content, .twoCols{
    grid-template-columns: 420px minmax(0, 1fr);
    padding-left: 40px;
    padding-right: 40px;
  }
  #cards{
    grid-template-columns: repeat(3, minmax(360px, 1fr));
    gap: 26px;
  }
  .card .thumb{ height: 340px; }
}

/* åœ¨è¼ƒå°è¢å¹•ä¸‹è‡ªå‹•æ”¶çª„å·¦å´ Advanced èˆ‡å³å´å…§å®¹ */
@media (max-width: 1300px) {
  .main, .content, .twoCols {
    grid-template-columns: 340px minmax(0, 1fr);
    padding-left: 16px;
    padding-right: 16px;
  }
}

/* å¦‚æœä½ ä»ç„¶ä¿ç•™äº† panel å¤–æ¡†ï¼Œæƒ³è¦æ›´å¹³é¢å¯é—œæ‰æ¨£å¼ï¼ˆæ²’æœ‰å°±å¿½ç•¥é€™æ®µï¼‰*/
.filters.panel, #resultsPanel.panel {
  background: transparent;
  border: 0;
  box-shadow: none;
}

/* === Facet Listï¼ˆAdvancedï¼‰å³å´æ•¸å­—å°é½Š === */
.fset .optRow{
  display: flex;                 /* label åœ¨å·¦ã€count åœ¨æœ€å³ */
  align-items: center;
  gap: 8px;
  padding: 2px 0;
}

/* è®“æ¨™ç±¤å æ»¿ä¸­é–“ç©ºé–“ï¼Œé¿å…æ“ åˆ° count */
.fset .optRow > label{
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1 1 auto;                /* æ’æ»¿ä¸­é–“ */
  min-width: 0;                  /* å…è¨±çœç•¥è™Ÿ */
}

/* å‹¾é¸æ¡†å¾®èª¿å‚ç›´å°é½Š */
.fset .optRow > label input[type="checkbox"]{
  transform: translateY(1px);
}

/* é•·æ¨™ç±¤çœç•¥è™Ÿè™•ç†ï¼ˆå¤šåœ‹åç¨±ä¸æœƒæŠŠæ•¸å­—æ“ ä¸‹å»ï¼‰ */
.fset .optRow > label strong{
  display: inline-block;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100%;
}

/* æ•¸å­—å›ºå®šåœ¨æœ€å³ä¸”ç­‰å¯¬å°é½Š */
.fset .optRow .count{
  margin-left: auto;             /* æ¨åˆ°æœ€å³ */
  flex: 0 0 auto;
  min-width: 3ch;                /* å›ºå®šæœ€å°å¯¬ï¼ˆ2~3 ä½æ•¸ä¸æŠ–å‹•ï¼‰ */
  text-align: right;
  color: var(--sub);
  font-variant-numeric: tabular-nums; /* ç­‰å¯¬æ•¸å­— */
  opacity: .95;
}

/* å°ä¸€é»çš„é …ç›®è¡Œè·ï¼Œæ•´é«”æ›´ç·Šå¯¦ */
.fset .optRow + .optRow{ margin-top: 2px; }

/* ã€ŒShow moreã€èˆ‡è¡Œæ–‡å°é½Š */
.fset .showMore{
  margin-top: 6px;
  padding: 0;
  align-self: flex-start;
}

/* === Age Chipsï¼šå¢åŠ é–“è·ã€å¯è‡ªå‹•æ›è¡Œ === */
#ageChips {
  display: flex;
  flex-wrap: wrap;           /* âœ… è¶…éå¯¬åº¦å°±è‡ªå‹•æ›è¡Œ */
  gap: 10px 12px;            /* âœ… å‚ç›´é–“è·10pxã€æ°´å¹³é–“è·12px */
  margin-top: 6px;
  align-items: flex-start;   /* ç¬¬ä¸€è¡Œèˆ‡ç¬¬äºŒè¡Œé ‚é½Š */
  justify-content: flex-start;
}
#ageChips .chip {
  flex: 0 0 auto;            /* ä¸å£“ç¸®ã€ä¸æ’æ»¿ */
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,.35);
  background: rgba(12,26,45,.35);
  color: #e8eff9;
  font-weight: 600;
  cursor: pointer;
  transition: background .2s ease, border-color .2s ease, color .2s ease;
}
#ageChips .chip:hover {
  background: rgba(34,73,130,.35);
  border-color: rgba(148,163,184,.6);
}
#ageChips .chip.active {
  background: rgba(40,90,150,.9);
  border-color: rgba(148,163,184,.9);
  color: #fff;
}
#cards.centerOne{
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 24px;
}
#cards.centerOne .card{
  max-width: 560px;
  width: 100%;
  padding-left: 50%;
}

/* ç¾¤çµ„æ¨™é¡Œ & Advanced è¦ç²—é«” */
.secTitle { font-weight: 800; }
.groupTitle { font-weight: 700; }

/* æ‰€æœ‰é¸é …ï¼ˆå« Anyï¼‰ä¸€å¾‹ä¸€èˆ¬å­—é‡ */
.optRow label,
#ct_phase_opts label,
#manufacturer_opts label,
#model_opts label,
#type_opts label,
#nat_opts label,
#year_opts label {
  font-weight: 400;
}

/* å‹•æ…‹æ¸…å–®è£¡çš„ <strong> å–æ¶ˆç²—é«”ï¼Œè®“å®ƒè·Ÿ Any ä¸€æ¨£ */
.optRow label strong,
#ct_phase_opts label strong,
#manufacturer_opts label strong,
#model_opts label strong,
#type_opts label strong,
#nat_opts label strong,
#year_opts label strong {
  font-weight: 400;
}
.optRow label .lbl { font-weight: 400; }
.secTitle { font-weight: 800; }
.groupTitle { font-weight: 700; }

:root {
  --single-results-offset: 22vw; /* å¡ç‰‡åç§»é‡ */
}

/* âœ… Results: é å·¦è²¼ä¸»é«”ï¼Œä¸å†è·Ÿè‘—åç§» */
.resultsHead.single {
  margin-left: -10vw;  /* å¯èª¿æ•´æˆ -2vw / -3vw å–æ±ºæ–¼è¦–è¦ºéœ€æ±‚ */
  padding-left: 16px; /* å°é½Šå…§å®¹å€æ•´é«”çš„ padding */
  text-align: left;
  width: auto;
}

/* âœ… çµæœå®¹å™¨ï¼šåªåç§»å¡ç‰‡å€åŸŸ */
#resultsPanel.single {
  margin-left: var(--single-results-offset);
  width: calc(100% - var(--single-results-offset));
}

/* âœ… å–®ç­†å¡ç‰‡ç½®ä¸­ */
#cards.centerOne {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 24px;
}
#cards.centerOne .card {
  flex: 0 0 340px;
  max-width: 340px;
  width: 100%;
  padding-left: 0 !important;
}

/* âœ… çª„è¢å¹•æ™‚å›æ­¸æ»¿å¯¬ */
@media (max-width: 900px) {
  .resultsHead.single {
    margin-left: 0;
    padding-left: 10px;
  }
  #resultsPanel.single {
    margin-left: 0;
    width: 100%;
  }
}

/* çµ±ä¸€å¡ç‰‡å­—å‹èˆ‡å¤§å° */
.card {
  font-family: "Segoe UI", "Inter", "Helvetica Neue", Arial, sans-serif;
  font-size: 15px;
  line-height: 1.4;
  color: #e2e8f0;
  font-weight: 500;
}

/* Case ID æ¨™é¡Œ */
.card .titleRow a {
  font-weight: 700;
  font-size: 15px;
  color: #60a5fa;
  text-decoration: none;
}
.card .titleRow a:hover {
  color: #93c5fd;
}

/* Sex / Age ç­‰æ¬„ä½ */
.card .keyRow {
  font-size: 15px;
  color: #cbd5e1;
}
.card .keyRow span.k {
  font-weight: 600;
}
.card .keyRow span.v {
  font-weight: 500;
}

/* Tumor æ¨™ç±¤ â€” åŒæ¨£å¤§å°ã€ä¸æ”¾å¤§ */
.card .tag.ok,
.card .tag.bad {
  font-size: 15px;
  font-weight: 600;
}
.card .tag.ok {
  color: #22c55e;  /* ç¶ è‰² */
}
.card .tag.bad {
  color: #ef4444;  /* ç´…è‰² */
}

</style>


    <!-- Browse -->
    <section class="panel container recBar" id="recBar">
        <div class="recTitle">Browse</div>
        <div class="recViewport">
            <button class="recCtrl recPrev" id="recPrev" title="Previous">â€¹</button>
            <button class="recCtrl recNext" id="recNext" title="Next">â€º</button>
            <button class="recPlay" id="recPlay" title="Pause/Play">â¸</button>
            <div id="recScroll" class="recScroll"></div>
        </div>
    </section>

    <!-- Main -->
<section class="main container">
  <aside id="filters" class="filters panel">
    <div class="secTitle">Advanced</div>

    <!-- CT phase -->
    <div class="fset" id="fs_ct">
      <div class="groupTitle">CT phase</div>
      <div class="optRow">
        <label><input type="checkbox" data-k="ct_phase" value="" checked> Any</label>
      </div>
      <div id="ct_phase_opts"></div>
      <button class="showMore" data-target="ct_phase_opts" data-limit="12">Show more</button>
    </div>

    <!-- Manufacturer -->
    <div class="fset" id="fs_mfr">
      <div class="groupTitle">Manufacturer</div>
      <div class="optRow">
        <label><input type="checkbox" data-k="manufacturer" value="" checked> Any</label>
      </div>
      <div id="manufacturer_opts"></div>
      <button class="showMore" data-target="manufacturer_opts" data-limit="12">Show more</button>
    </div>

    <!-- Model -->
    <div class="fset" id="fs_model">
      <div class="groupTitle">Model</div>
      <div class="optRow">
        <label><input type="checkbox" data-k="model" value="" checked> Any</label>
      </div>
      <div id="model_opts"></div>
      <button class="showMore" data-target="model_opts" data-limit="12">Show more</button>
    </div>

    <!-- Study type -->
    <div class="fset" id="fs_type">
      <div class="groupTitle">Study type</div>
      <div class="optRow">
        <label><input type="checkbox" data-k="study_type" value="" checked> Any</label>
      </div>
      <div id="type_opts"></div>
      <button class="showMore" data-target="type_opts" data-limit="12">Show more</button>
    </div>

    <!-- Site nationality -->
    <div class="fset" id="fs_nat">
      <div class="groupTitle">Site nationality</div>
      <div class="optRow">
        <label><input type="checkbox" data-k="site_nat" value="" checked> Any</label>
      </div>
      <div id="nat_opts"></div>
      <button class="showMore" data-target="nat_opts" data-limit="12">Show more</button>
    </div>

    <!-- Study year -->
    <div class="fset" id="fs_year">
      <div class="groupTitle">Study year</div>
      <div class="optRow">
        <label><input type="checkbox" data-k="year" value="" checked> Any</label>
      </div>
      <div id="year_opts"></div>
      <button class="showMore" data-target="year_opts" data-limit="20">Show more</button>
    </div>
  </aside>

  <section id="resultsPanel" class="panel" style="display:none">
    <div class="resultsHead" style="display:none">
      <div id="counter" class="counter">Results: 0 cases</div>
      <select id="sortBy" class="select">
        <option value="quality">Quality (high â†’ low)</option>
        <option value="spacing_asc">Spacing (low â†’ high)</option>
        <option value="shape_desc">Shape score (high â†’ low)</option>
        <option value="age_asc">Age (young â†’ old)</option>
        <option value="age_desc">Age (old â†’ young)</option>
        <option value="id_asc">ID (low â†’ high)</option>
        <option value="id_desc">ID (high â†’ low)</option>
      </select>
    </div>
    <div id="cards" class="cards" aria-live="polite" style="display:none"></div>
  </section>
</section>


    <!-- Preparing Page -->
    <div id="prepPage" class="prepPage" aria-hidden="true">
        <div class="prepBox">
            <img id="prepImg" src="" alt=""
                style="width:180px;height:110px;border-radius:12px;background:#dcd7ce;display:block;margin:0 auto 12px;">
            <div class="prepTitle">Preparing data...</div>
            <div class="prepHint">â€¹ pancreas â€º</div>
        </div>
    </div>

    <!-- Viewer -->
    <section id="viewer" class="viewer" aria-hidden="true">
        <div class="v-toolbar">
            <button class="iconBtn" id="btnBack" title="Back to search">â†©</button>
            <button class="iconBtn" id="btnGear" title="Viewer settings">âš™ï¸</button>
            <button class="iconBtn" id="btnClassMap" style="display:none" aria-hidden="true">ğŸ—ºï¸</button>
        </div>

        <aside class="v-sidebar" id="vSidebar" style="display:none">
            <div class="cm">
                <div class="cm-head">
                    <h3 style="margin:0">Organs</h3>
                    <button class="toggleAll" id="toggleAll">Toggle all</button>
                </div>
                <div id="cmRoot"></div>
            </div>
        </aside>

        <div class="v-card" id="vCard" style="display:none">
            <h5 id="caseTitle" style="margin:2px 0 8px">Case ID: â€”</h5>
            <div class="row"><label style="min-width:95px;color:#9aa3b2">Label Opacity</label><input id="op"
                    type="range" min="0" max="100" value="60"><span id="opv" class="value">60</span></div>
            <div class="row"><label style="min-width:95px;color:#9aa3b2">Level</label><input id="lvl" type="range"
                    min="-200" max="200" value="50"><span id="lvlv" class="value">50</span></div>
            <div class="row"><label style="min-width:95px;color:#9aa3b2">Window</label><input id="win" type="range"
                    min="100" max="2000" value="400"><span id="winv" class="value">400</span></div>

            <button id="openClassMap" class="btn" style="width:100%;margin-top:10px">Class Map</button>
            <div class="v-actions">
                <button id="zoomIn" class="toolBtn" title="Zoom in"></button>
                <button id="zoomOut" class="toolBtn" title="Zoom out"></button>
                <button id="download" class="toolBtn" title="Download"></button>
                <button id="report" class="toolBtn" title="Report"></button>
            </div>
        </div>

        <main class="v-stage">
            <section class="v-view">
                <h4>Axial</h4><img id="axial" alt="axial">
            </section>
            <section class="v-view">
                <h4>Sagittal</h4><img id="sagittal" alt="sagittal">
            </section>
            <section class="v-view">
                <h4>Coronal</h4><img id="coronal" alt="coronal">
            </section>
            <section class="v-view">
                <h4>3D</h4>
                <div class="center" id="prep">
                    <div class="mini"></div>
                    <div>Preparing dataâ€¦</div>
                    <div style="color:#8ea6ff;margin-top:4px">â€¹ pancreas â€º</div>
                </div>
            </section>
        </main>
    </section>

    <!-- Report Modal -->
    <div id="reportModal" class="modal" aria-hidden="true">
        <div class="modalBox">
            <div class="modalHead">
                <h3 style="margin:0">Case Report</h3>
                <button id="rpClose" class="iconBtn sm">âœ•</button>
            </div>
            <div class="modalBody">
                <p style="color:#9aa3b2">Report content goes hereâ€¦</p>
            </div>
        </div>
    </div>

    <script>

// é¡¯ç¤ºã€ŒResults: â€¦ã€/ è¨­å®šç¸½æ•¸
function setResultsLoading(on = true) {
  const el = document.querySelector('#resCount, .resultsHead .counter');
  if (!el) return;
  el.textContent = on ? 'Results: â€¦' : el.textContent;
}

function setResultsCount(n) {
  const el = document.querySelector('#resCount, .resultsHead .counter');
  if (!el) return;
  el.textContent = `Results: ${n} ${n === 1 ? 'case' : 'cases'}`;
}


/* ===== helpers ===== */
// âœ… å®‰å…¨ç‰ˆæœ¬ï¼ˆé¿å…é‡è¤‡å®£å‘Šï¼‰
window._showEl = window._showEl || function (sel, on) {
  const n = typeof sel === 'string' ? document.querySelector(sel) : sel;
  if (!n) return;
  if (on) n.style.removeProperty('display');
  else n.style.display = 'none';
};



// --- Profile helpers (HuggingFace) ---
function pad8(n){
  const s = String(n ?? '').replace(/\D/g, '');
  return s ? s.padStart(8, '0') : '';
}
function profileURL(idNum){
  const p = pad8(idNum);
  if (!p) return '';
  return `https://huggingface.co/datasets/BodyMaps/iPanTSMini/resolve/main/profile_only/PanTS_${p}/profile.jpg`;
}
function extractNumFromId(idStr){
  const m = String(idStr || '').match(/\d+/);
  return m ? Number(m[0]) : NaN;
}

const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
const svg = (t, b = '#0f223b', f = '#94a3b8') => 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><rect width="400" height="300" fill="${b}"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18" fill="${f}">${t}</text></svg>`);
const vsvg = t => 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><rect width="400" height="300" fill="#0a0d18"/><text x="50%" y="50%" fill="#9aa3b2" text-anchor="middle" dominant-baseline="middle" font-family="Arial" font-size="16">${t}</text></svg>`);

const state = {
  q: '',
  sex: [],            // ['M','F','UNKNOWN']
  tumor: '',
  age_from: '',
  age_to: '',
  age_bin: [],        // ['0-9','10-19',...,'90-99','UNKNOWN']
  sort_by: 'quality',
  ct_phase: [],
  manufacturer: [],
  model: [],
  study_type: [],
  site_nat: [],
  year: [],
  per_page: 10000,
  page: 1
};

let ALL_ITEMS = [], lastFetched = [];
let HAS_SEARCHED = false;

/* ---- UI helpers (safe, no re-declare) ---- */
window._toggleEl = window._toggleEl || function (selOrNode, on) {
  const n = (typeof selOrNode === 'string') ? document.querySelector(selOrNode) : selOrNode;
  if (!n) return;
  if (on) n.style.removeProperty('display'); else n.style.display = 'none';
};

/* ---- Panels / Results refresh ---- */
function updatePanels() {
  const searched = !!HAS_SEARCHED;
  const count = searched ? (Number(window.LAST_TOTAL ?? (lastFetched?.length || 0)) || 0) : 0;

  // æƒ³è¦ 0 ç­†ä¹Ÿé¡¯ç¤º Results æ¨™é¡Œï¼šheadã€panel éƒ½è·Ÿè‘— searched é¡¯ç¤º
  const showHead   = searched;               // 0 ç­†ä¹Ÿé¡¯ç¤ºã€ŒResults: 0 casesã€
  const showPanel  = searched;               // 0 ç­†ä¿ç•™å³å´çµæœé¢æ¿çš„å®¹å™¨ï¼ˆä¸å¡å¡ç‰‡ï¼‰
  const showCards  = searched && count > 0;  // åªæœ‰æœ‰çµæœæ‰é¡¯ç¤ºå¡ç‰‡
  const showBrowse = !showCards;             // åªè¦æ²’æœ‰å¡ç‰‡ï¼ˆå« 0 ç­†ï¼‰å°±é¡¯ç¤º Browse

  // æ›´æ–°æ•¸å­—
  if (typeof setResultsCount === 'function') {
    setResultsCount(count);
  } else {
    const counterEl = document.getElementById('counter') || document.querySelector('.counter');
    if (counterEl) counterEl.textContent = `Results: ${count} ${count === 1 ? 'case' : 'cases'}`;
  }

  // é¡¯ç¤º/éš±è—ä¸»è¦å€å¡Šï¼ˆæ³¨æ„ï¼šhead/panel æ°¸é è·Ÿ searchedï¼ŒåŒæ­¥ï¼›cards ä¾ countï¼‰
  window._toggleEl = window._toggleEl || function (selOrNode, on) {
    const n = (typeof selOrNode === 'string') ? document.querySelector(selOrNode) : selOrNode;
    if (!n) return; if (on) n.style.removeProperty('display'); else n.style.display = 'none';
  };
  window._toggleEl('.resultsHead', showHead);
  window._toggleEl('#resultsPanel', showPanel);
  window._toggleEl('#cards', showCards);
  window._toggleEl('#recBar', showBrowse);

  // Advanced é¢æ¿ï¼šå¤šç­†æ‰é¡¯ç¤º
  const filt = document.getElementById('filters');
  if (filt) {
    const showFilter = showCards && count > 1;
    filt.classList.toggle('show', showFilter);
    window._toggleEl(filt, showFilter);
  }

  // å–®ç­†è¦–è¦º
  const mainEl  = document.querySelector('.main') || document.querySelector('.content') || document.querySelector('.twoCols');
  const panelEl = document.getElementById('resultsPanel');
  const cardsEl = document.getElementById('cards');

  if (showCards && count === 1) {
    mainEl?.classList.add('singleResult');
    panelEl?.classList.add('spanAll');
    cardsEl?.classList.add('centerOne');
  } else {
    mainEl?.classList.remove('singleResult');
    panelEl?.classList.remove('spanAll');
    cardsEl?.classList.remove('centerOne');
  }

  // æ’åºä¸‹æ‹‰ï¼ˆå–®ç­†æ™‚é—œé–‰ï¼›0 ç­†ä¹Ÿé—œï¼‰
  const sortSel = document.getElementById('sortBy');
  if (sortSel) {
    const wrap = sortSel.closest('.sortWrap') || sortSel;
    if (count <= 1) {
      wrap.style.display = 'none';
      sortSel.disabled = true;
      if (state.sort_by !== 'quality') state.sort_by = 'quality';
    } else {
      wrap.style.display = '';
      sortSel.disabled = false;
    }
  }
}


function wirePopSafe(root) {
  if (!root) return;
  const btn = root.querySelector('.popBtn');
  if (!btn) return;

  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    root.classList.toggle('open');
    $$('.pop.open').forEach(p => { if (p !== root) p.classList.remove('open'); });
  });

  root.querySelector('.popPanel')?.addEventListener('click', (e) => e.stopPropagation());
  document.addEventListener('click', (e) => { if (!root.contains(e.target)) root.classList.remove('open'); });
}
wirePopSafe(document.getElementById('popID'));
wirePopSafe(document.getElementById('popSTA'));

async function fetchJSON(u) {
  const r = await fetch(u, { cache: 'no-store' });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}


/* quality helpers */
function idNum(x) { const m = String(x.case_id || x['PanTS ID'] || x.id).match(/\d+/) || [0]; return Number(m[0]); }
function isComplete(it) {
  const sexOK = it.sex === 'M' || it.sex === 'F';
  const ageOK = Number.isFinite(it.age) && it.age > 0;
  const tumorOK = it.tumor === 0 || it.tumor === 1;
  const spOK = Number.isFinite(it.spacing_sum) && it.spacing_sum > 0;
  const shOK = Number.isFinite(it.shape_sum) && it.shape_sum > 0;
  return sexOK && ageOK && tumorOK && spOK && shOK;
}
/* quality helpersï¼ˆç•¶å‰æª”æ¡ˆå·²å­˜åœ¨ isComplete, idNum ç­‰ï¼‰ */
function compareQuality(a, b) {
  // 1) å®Œæ•´åº¦å„ªå…ˆï¼ˆage/sex/tumor/spacing/shape éƒ½æœ‰å€¼ï¼‰
  const ca = isComplete(a), cb = isComplete(b);
  if (ca !== cb) return cb - ca;

  // 2) ä»¥è¦–é‡å¤§å°ç‚ºä¸»ï¼ˆshape_sum è¶Šå¤§è¶Šå¥½ï¼‰
  const shA = a.shape_sum ?? -1, shB = b.shape_sum ?? -1;
  if (shA !== shB) return shB - shA;

  // 3) è§£æåº¦ï¼šspacing ç¸½å’Œè¶Šå°è¶Šå¥½ï¼ˆxyz pixel spacing ç›¸åŠ ï¼‰
  const spA = a.spacing_sum ?? 1e9, spB = b.spacing_sum ?? 1e9;
  if (spA !== spB) return spA - spB;

  // 4) æœ€å¾Œç”¨ ID è®“æ’åºç©©å®š
  return idNum(a) - idNum(b);
}

/* Browse */
let recTimer = null, recPlaying = true;

async function initBrowse() {
  try {
    if (recTimer) { clearInterval(recTimer); recTimer = null; }
    const bar = $('#recScroll');
    if (!bar) return;
    bar.innerHTML = '';

    let source = [];
    if (ALL_ITEMS && ALL_ITEMS.length) {
      source = ALL_ITEMS;
    } else {
      const r = await fetchJSON('/api/random?n=120&k=240&scope=filtered');
      source = r.items || [];
    }

    // ====== å¸¸æ•¸ ======
    const MIN_SHAPE_SUM    = 750;
    const MAX_SPACING_SUM  = 6.0;
    const MIN_Z            = 220;
    const MAX_Z_SPACING    = 1.2;
    const MIN_XY_MIN       = 360;

    const POS_HINTS = ['chest','thorax','abdomen','abdo','pelvis','cap','tap','soft','venous','portal','contrast'];
    const NEG_HINTS = ['spine','cervical','thoracic','lumbar','vertebra','scolio','bone','bony','osseous','orthopedic','skeletal','mip','recon','localizer','scout'];

    // â›” æ˜ç¢ºæ’é™¤åå–®
    const BAD_IDS = ['PanTS_00006171', 'PanTS_00009810', 'PanTS_00009809'];

    // ---- helpers ----
    const idOf = (it) => String(it?.id || it?.case_id || it?.name || it?.['PanTS ID'] || '');
    const toNum = (v) => { const n = Number(v); return Number.isFinite(n) ? n : null; };
    const parseTriplet = (raw) => {
      if (!raw) return null;
      if (Array.isArray(raw) && raw.length >= 3) {
        const a = [toNum(raw[0]), toNum(raw[1]), toNum(raw[2])];
        return a.every(x=>x!==null) ? a : null;
      }
      const s = String(raw).trim();
      if (!s) return null;
      const parts = s.replace(/[\[\]\(\)\{\}]/g,' ')
                     .replace(/[xX,;|]/g,' ')
                     .split(/\s+/).filter(Boolean).map(Number);
      if (parts.length >= 3 && parts.slice(0,3).every(Number.isFinite)) return parts.slice(0,3);
      return null;
    };
    const shapeXYZ   = (it) => parseTriplet(it.shape ?? it.shape_str ?? it.shapeXYZ);
    const spacingXYZ = (it) => parseTriplet(it.spacing ?? it.spacing_str ?? it.spacingXYZ);

    // åå¥½ï¼ˆä¸»éæ¿¾ï¼‰
    const prefer = (it) => {
      if (!isComplete(it)) return false;
      if (BAD_IDS.includes(idOf(it))) return false; // â›” ç›´æ¥æ“‹

      const st = String(it.study_type || '').toLowerCase();
      if (NEG_HINTS.some(k => st.includes(k))) return false;

      const shp = shapeXYZ(it), spc = spacingXYZ(it);
      if (!shp || !spc) return false;

      const [sx, sy, sz]    = shp;
      const [spx, spy, spz] = spc;
      if (![sx,sy,sz,spx,spy,spz].every(Number.isFinite)) return false;

      const xyOK      = Math.min(sx, sy) >= MIN_XY_MIN;
      const zOK       = sz >= MIN_Z;
      const zSpOK     = spz <= MAX_Z_SPACING;

      const shapeOK   = (it.shape_sum   ?? (sx+sy+sz))   >= MIN_SHAPE_SUM;
      const spacingOK = (it.spacing_sum ?? (spx+spy+spz)) <= MAX_SPACING_SUM;

      return xyOK && zOK && zSpOK && shapeOK && spacingOK;
    };

    // æ’åº
    const scorePos = (it) => {
      const st = String(it.study_type || '').toLowerCase();
      return POS_HINTS.reduce((s, k) => s + (st.includes(k) ? 1 : 0), 0);
    };
    const byCuratedQuality = (a, b) => {
      const [ , , za] = shapeXYZ(a) || [null,null,null];
      const [ , , zb] = shapeXYZ(b) || [null,null,null];
      const [ , , zsa]= spacingXYZ(a) || [null,null,null];
      const [ , , zsb]= spacingXYZ(b) || [null,null,null];

      if (zsa !== zsb) return (zsa ?? 1e9) - (zsb ?? 1e9);   // spacingZ å°å„ªå…ˆ
      if (za  !== zb ) return (zb  ?? -1) - (za  ?? -1);     // shapeZ å¤§å…¶æ¬¡

      const shA = (a.shape_sum ?? ((shapeXYZ(a)||[0,0,0]).reduce((p,c)=>p+c,0)));
      const shB = (b.shape_sum ?? ((shapeXYZ(b)||[0,0,0]).reduce((p,c)=>p+c,0)));
      if (shA !== shB) return shB - shA;

      const spA = (a.spacing_sum ?? ((spacingXYZ(a)||[1e9,1e9,1e9]).reduce((p,c)=>p+c,0)));
      const spB = (b.spacing_sum ?? ((spacingXYZ(b)||[1e9,1e9,1e9]).reduce((p,c)=>p+c,0)));
      if (spA !== spB) return spA - spB;

      const sA = scorePos(a), sB = scorePos(b);
      if (sA !== sB) return sB - sA;

      return idNum(a) - idNum(b);
    };

    // åš´æ ¼éæ¿¾ï¼›ä¸è¶³å‰‡ fallbackï¼ˆä»æ’é™¤ BAD_IDSï¼‰
    const filtered = source.filter(prefer);
    const fallback = () => {
      const loose = source.filter(it => {
        if (!isComplete(it)) return false;
        if (BAD_IDS.includes(idOf(it))) return false; // â›” ä»æ“‹
        const st = String(it.study_type || '').toLowerCase();
        if (NEG_HINTS.some(k => st.includes(k))) return false;

        const shp = shapeXYZ(it), spc = spacingXYZ(it);
        if (!shp || !spc) return false;
        const [sx, sy, sz] = shp;
        const [ , , spz ]  = spc;

        const xyOK  = Math.min(sx, sy) >= (MIN_XY_MIN - 20);
        const zOK   = sz >= (MIN_Z - 20);
        const zSpOK = spz <= (MAX_Z_SPACING + 0.3);

        const shapeOK   = (it.shape_sum ?? (sx+sy+sz)) >= (MIN_SHAPE_SUM - 80);
        const spacingOK = (it.spacing_sum ?? (spc[0]+spc[1]+spc[2])) <= (MAX_SPACING_SUM + 1.0);

        return xyOK && zOK && zSpOK && shapeOK && spacingOK;
      });
      return loose.length ? loose : source.filter(it => isComplete(it) && !BAD_IDS.includes(idOf(it)));
    };

    const ranked = (filtered.length ? filtered : fallback()).sort(byCuratedQuality);

    // æœ€å¾Œå†ä¿éšªä¸€æ¬¡ï¼šæŠŠ BAD_IDS å‰”é™¤
    const best = ranked.filter(it => !BAD_IDS.includes(idOf(it))).slice(0, 20);

    if (!best.length) {
      const empty = document.createElement('article');
      empty.className = 'card inRec';
      empty.innerHTML = `
        <div class="body" style="padding:12px 14px">
          <div class="titleRow"><span class="recId" style="font-weight:900">No items</span></div>
          <div class="keyRow" style="margin-top:6px;color:#93a4b8">Try adjusting filters, then Search</div>
        </div>`;
      bar.appendChild(empty);
      $('#recPrev')?.setAttribute('disabled', 'disabled');
      $('#recNext')?.setAttribute('disabled', 'disabled');
      $('#recPlay')?.setAttribute('disabled', 'disabled');
      return;
    } else {
      $('#recPrev')?.removeAttribute('disabled');
      $('#recNext')?.removeAttribute('disabled');
      $('#recPlay')?.removeAttribute('disabled');
    }

    const frag = document.createDocumentFragment();
    best.forEach(it => { const card = makeCard(it); card.classList.add('inRec'); frag.appendChild(card); });
    bar.appendChild(frag);

    const vp = document.querySelector('.recViewport');
    const firstCard = bar.querySelector('.card') || bar.querySelector('.recCard');
    if (vp && firstCard) {
      const h = Math.ceil(firstCard.getBoundingClientRect().height);
      vp.style.minHeight = h + 'px';
    }

    const scroller = bar;
    const gap = 12;
    let step = firstCard ? (firstCard.getBoundingClientRect().width + gap) : 340;

    const atEnd = () => (scroller.scrollLeft + scroller.clientWidth) >= (scroller.scrollWidth - 2);
    const tick = () => { if (atEnd()) scroller.scrollTo({ left: 0, behavior: 'smooth' }); else scroller.scrollBy({ left: step, behavior: 'smooth' }); };

    $('#recPrev').onclick = (e) => { e?.preventDefault?.(); e?.stopPropagation?.(); scroller.scrollBy({ left: -step, behavior: 'smooth' }); };
    $('#recNext').onclick = (e) => { e?.preventDefault?.(); e?.stopPropagation?.(); scroller.scrollBy({ left: +step, behavior: 'smooth' }); };
    $('#recPlay').onclick = (e) => {
      e?.preventDefault?.(); e?.stopPropagation?.();
      recPlaying = !recPlaying;
      $('#recPlay').textContent = recPlaying ? 'â¸' : 'â–¶';
      if (recPlaying) startAuto(); else stopAuto();
    };

    function startAuto() { stopAuto(); recTimer = setInterval(tick, 3500); }
    function stopAuto()  { if (recTimer) { clearInterval(recTimer); recTimer = null; } }

    $('#recPlay').textContent = recPlaying ? 'â¸' : 'â–¶';
    if (recPlaying) startAuto();

    if (window._recResizeHandler) window.removeEventListener('resize', window._recResizeHandler);
    window._recResizeHandler = () => {
      const first = bar.querySelector('.card') || bar.querySelector('.recCard');
      step = first ? (first.getBoundingClientRect().width + gap) : 340;
    };
    window.addEventListener('resize', window._recResizeHandler, { passive: true });

    ['recPrev','recNext','recPlay'].forEach((id) => {
      const btn = document.getElementById(id);
      if (!btn) return;
      btn.tabIndex = 0;
      if (!btn.getAttribute('aria-label')) {
        btn.setAttribute('aria-label', id === 'recPrev' ? 'Previous' : id === 'recNext' ? 'Next' : 'Pause/Play');
      }
      btn.addEventListener('mousedown', (e) => e.preventDefault());
      btn.addEventListener('keydown', (e) => {
        const k = e.key;
        const shouldClick =
          k === 'Enter' || k === ' ' ||
          (id === 'recPrev' && k === 'ArrowLeft') ||
          (id === 'recNext' && k === 'ArrowRight') ||
          (id === 'recPlay' && (k === 'k' || k === 'K'));
        if (shouldClick) { e.preventDefault(); e.stopPropagation(); btn.click(); }
      });
    });
  } catch (e) {
    console.warn('initBrowse failed:', e);
  }
}




const FACET_PAIRS = [
  ['ct_phase_opts', 'ct_phase'],
  ['manufacturer_opts', 'manufacturer'],
  ['model_opts', 'model'],
  ['type_opts', 'study_type'],
  ['nat_opts', 'site_nat'],
  ['year_opts', 'year'],
];
/* Lists / facets */
const SPLIT_RE = /[;,|/ã€ï¼ŒÂ·ãƒ»]+/;
const NAT_MAP = { 'USA': 'US', 'U.S.': 'US', 'U S A': 'US', 'GB': 'UK', 'U.K.': 'UK', 'N/A': 'NA', 'NULL': 'NA' };
const normToken = s => (s ?? '').toString().trim().toUpperCase();
const mapNat = code => NAT_MAP[normToken(code)] ?? normToken(code);
const splitTokens = (raw, mapper = x => x) => String(raw ?? '').split(SPLIT_RE).map(t => mapper(normToken(t))).filter(Boolean);
const pickField = (obj, cands) => { for (const k of cands) { if (Object.prototype.hasOwnProperty.call(obj, k)) { const v = obj[k]; if (v == null) continue; const s = String(v).trim(); if (s !== '' && s.toLowerCase() !== 'unknown') return v; } } return ''; };

/* --- å»ºç«‹æ¸…å–®ï¼ˆåˆæ¬¡ï¼‰ --- */
function buildFacetList(container, key, rows, hasLabel = false){
  const box = document.getElementById(container);
  if (!box) return;
  box.innerHTML = '';

  const validRows = (rows || [])
    .filter(r => (r.count ?? 0) > 0)
    .sort((a,b) => (b.count??0)-(a.count??0));

  validRows.forEach(r => {
    const text = hasLabel ? (r.label || r.value) : r.value;
    const d = document.createElement('div');
    d.className = 'optRow';
    d.dataset.k = key;
    d.dataset.v = String(r.value);
    d.innerHTML = `<label><input type="checkbox" data-k="${key}" value="${r.value}"> <span class="lbl">${text}</span></label> <span class="count">${r.count ?? 0}</span>`;

    box.appendChild(d);
  });

  const fset = box.closest('.fset');
  if (fset) fset.style.display = box.children.length ? '' : 'none';
}

/* --- Show more / less --- */
function wireShowMore(){
  document.querySelectorAll('.showMore').forEach(btn=>{
    const targetId = btn.dataset.target;
    const limit = parseInt(btn.dataset.limit || '12', 10);
    const box = document.getElementById(targetId);
    if (!box) return;

    const apply = () => {
      const rows = Array.from(box.querySelectorAll('.optRow'))
        .filter(r => r.dataset.hiddenByCount !== '1'); // è¢« count=0 éš±è—çš„ä¸åˆ—å…¥åˆ†é 
      const expanded = box.classList.contains('expanded');
      rows.forEach((row, idx) => row.style.display = (expanded || idx < limit) ? 'flex' : 'none');
      btn.style.display = (rows.length > limit) ? '' : 'none';
      btn.textContent = expanded ? 'Show less' : 'Show more';
    };

    btn.addEventListener('click', () => { box.classList.toggle('expanded'); apply(); });
    box._applyPager = apply;  // æä¾›å¤–éƒ¨ï¼ˆæ›´æ–°æ•¸å­—å¾Œï¼‰é‡ç®—
    apply();
  });
}

function updateFacetCounts(countPayload = {}) {
  FACET_PAIRS.forEach(([containerId, key]) => {
    const box = document.getElementById(containerId);
    if (!box) return;

    const rows  = Array.from(box.querySelectorAll('.optRow'));
    const mp    = Object.create(null);
    (countPayload[key] || []).forEach(r => { mp[String(r.value)] = r.count || 0; });

    rows.forEach(row => {
      const input = row.querySelector('input[type=checkbox]');
      const val   = row.dataset.v || (input ? input.value : '');
      const cnt   = (val in mp) ? mp[val] : 0;

      // æ›´æ–°æ•¸å­—
      const badge = row.querySelector('.count');
      if (badge) badge.textContent = cnt;

      // è¦å‰‡ï¼šcount=0 æ™‚è‹¥å°šæœªå‹¾é¸ â†’ disabledï¼›å·²å‹¾é¸å‰‡ä¿æŒå¯ç”¨
      const checked = !!(input && input.checked);
      if (input) {
        input.disabled = (!checked && cnt === 0);
        row.classList.toggle('disabled', input.disabled);
      }

      // ä¸éš±è—ï¼Œå…¨éƒ¨ä¿ç•™é¡¯ç¤ºï¼ˆè‹¥ä½ æƒ³éš±è— 0ï¼Œå¯ä»¥æŠŠä¸‹ä¸€è¡Œæ”¹æˆ row.style.display = (checked || cnt>0) ? 'flex' : 'none';
      row.style.display = (checked || cnt > 0) ? 'flex' : 'none';
row.dataset.hiddenByCount = (checked || cnt > 0) ? '0' : '1';
    });

    // å°è¨ˆï¼šæ•´çµ„æ˜¯å¦å…¨ç‚º 0 ä¸”ç„¡å‹¾é¸ï¼Ÿè‹¥æ˜¯ï¼Œä¹Ÿä¿ç•™é¡¯ç¤ºï¼ˆä¸æŠ˜ç–Šï¼‰ï¼Œä¾¿æ–¼ä½¿ç”¨è€…ç†è§£ç‚ºã€Œç›®å‰æ¢ä»¶ä¸‹ç„¡è³‡æ–™ã€
    const fset = box.closest('.fset');
    if (fset) fset.style.display = rows.length ? '' : 'none';

    // è®“ã€ŒShow more/lessã€åœ¨æ›´æ–°å¾Œé‡ç®—ä¸€æ¬¡å¯è¦‹åˆ—æ•¸
    box._applyPager?.();
  });
}

/* --- æ”¶é›† Advanced å‹¾é¸ â†’ stateï¼ˆAny èˆ‡å…¶ä»–äº’æ–¥ï¼‰ --- */
function collectAdvanced() {
  const pickVals = k =>
    Array.from(document.querySelectorAll(`#filters input[type=checkbox][data-k="${k}"]:checked`))
      .map(i => String(i.value)).filter(v => v !== '');

  // åŒä¸€çµ„å…§è™•ç†ã€ŒAnyã€äº’æ–¥
  const enforceAny = (k) => {
    const list = Array.from(document.querySelectorAll(`#filters input[type=checkbox][data-k="${k}"]`));
    const any  = list.find(x => x.value === '');
    const restChecked = list.some(x => x.value !== '' && x.checked);
    if (any) any.checked = !restChecked;
  };

  ['ct_phase','manufacturer','model','study_type','site_nat','year'].forEach(enforceAny);

  state.ct_phase     = pickVals('ct_phase');
  state.manufacturer = pickVals('manufacturer');
  state.model        = pickVals('model');
  state.study_type   = pickVals('study_type');
  state.site_nat     = pickVals('site_nat');
  state.year         = pickVals('year');

  updateSTASummary?.();

  // å‹¾é¸è®Šå‹•å¾Œï¼šå³æ™‚è¨ˆç®— facetï¼ˆä¾ç•¶å‰å…¨éƒ¨æ¢ä»¶ï¼‰ï¼Œä¸¦åœ¨å·²æœå°‹ä¸‹è§¸ç™¼çµæœåˆ·æ–°
  refreshFacetsDebounced(0);
window.HAS_SEARCHED = true;  // ç¬¬ä¸€æ¬¡æŒ‰ advanced ä¹Ÿç•¶ä½œå·²æœå°‹
run();
}

/* --- æŠŠ state è½‰æˆæŸ¥è©¢å­—ä¸²ï¼ˆfacets / search å…±ç”¨ï¼‰ --- */
function qsFromState() {
  const p = new URLSearchParams();

  if (state.q) p.set('caseid', state.q);

  if (Array.isArray(state.sex) && state.sex.length) state.sex.forEach(v => p.append('sex[]', v));
  if (state.tumor !== '') p.set('tumor', state.tumor);

  if (Array.isArray(state.age_bin) && state.age_bin.length) {
    state.age_bin.forEach(v => p.append('age_bin[]', v));
  } else {
    if (state.age_from) p.set('age_from', state.age_from);
    if (state.age_to)   p.set('age_to',   state.age_to);
  }

  ['ct_phase', 'manufacturer', 'model', 'study_type', 'site_nat', 'year']
    .forEach(k => (state[k] || []).forEach(v => p.append(k + '[]', v)));

  if (state.sort_by)  p.set('sort_by',  state.sort_by);
  if (state.page)     p.set('page',     state.page);
  if (state.per_page) p.set('per_page', state.per_page);

  return p.toString();
}



/* === ä¸€æ¬¡æ€§åˆå§‹åŒ–ï¼šå»ºç«‹ Advanced æ¸…å–®ã€ç¶å®šäº‹ä»¶ === */
(async function primeUI() {
  // 1) å…ˆæ‹‰å…¨é›† facetsï¼ˆguarantee=1ï¼‰ä¾†ã€Œå»ºæ¸…å–®ã€
  let f0 = { facets: {} };
  try {
    f0 = await fetchJSON('/api/facets?fields=ct_phase,manufacturer,model,study_type,site_nat,year&top_k=999&guarantee=1');
  } catch (e) {
    console.warn('facets fetch failed:', e);
  }
  const fx = f0?.facets || {};

  // 2) ä¾ fx å»ºå‡ºå„çµ„æ¸…å–®ï¼ˆåªåšä¸€æ¬¡ï¼‰
  try {
    if (document.getElementById('ct_phase_opts')) buildFacetList('ct_phase_opts', 'ct_phase', fx.ct_phase || []);
    if (document.getElementById('manufacturer_opts')) buildFacetList('manufacturer_opts', 'manufacturer', fx.manufacturer || []);
    if (document.getElementById('model_opts')) buildFacetList('model_opts', 'model',
      (fx.model || []).map(r => ({ value: r.value, label: r.label ?? r.value, count: r.count })), true);
    if (document.getElementById('type_opts')) buildFacetList('type_opts', 'study_type', fx.study_type || []);
    if (document.getElementById('nat_opts')) buildFacetList('nat_opts', 'site_nat',
      (fx.site_nat || []).map(r => ({ value: r.value, label: r.label ?? r.value, count: r.count })), true);
    if (document.getElementById('year_opts')) buildFacetList('year_opts', 'year',
      (fx.year || []).map(r => ({ value: String(r.value), count: r.count })));
  } catch (e) {
    console.warn('build facet list failed:', e);
  }

  // 3) Show more/less åˆ†é å™¨æ›ä¸Š
  wireShowMore?.();

  // 4) å…ˆæŠŠã€Œå…¨é›†ã€çš„æ•¸å­—ç•«ä¸Šï¼ˆé é¢åˆå§‹ç‹€æ…‹ï¼‰
  updateFacetCounts(fx);

  // 5) ç¶ Advanced å‹¾é¸äº‹ä»¶ï¼ˆã€ŒAnyã€äº’æ–¥ + live counts + è‹¥å·²æœå°‹å‰‡åˆ·æ–°çµæœï¼‰
  const filtersEl = document.getElementById('filters');
  if (filtersEl) {
    filtersEl.addEventListener('change', e => {
      const cb = e.target?.closest?.('input[type=checkbox][data-k]');
      if (!cb) return;

      const key   = cb.dataset.k;
      const isAny = (cb.value === '');

      // ã€ŒAnyã€èˆ‡å…¶ä»–äº’æ–¥
      if (isAny) {
        document.querySelectorAll(`#filters input[type=checkbox][data-k="${key}"]`)
          .forEach(x => x.checked = (x === cb));
      } else {
        const any = document.querySelector(`#filters input[type=checkbox][data-k="${key}"][value=""]`);
        if (any) any.checked = false;
      }

      collectAdvanced(); // å…§éƒ¨æœƒ debounced è§¸ç™¼ refreshFacets()ï¼Œä¸¦åœ¨ HAS_SEARCHED æ™‚ run()
    });
  }
})();
/* Recent helpersï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰ */
function saveRecent(id) {
  try {
    const key = 'recentIds';
    const cur = JSON.parse(localStorage.getItem(key) || '[]');
    const idStr = String(id || '').trim();
    if (!idStr) return;
    const next = [idStr, ...cur.filter(x => x !== idStr)].slice(0, 12);
    localStorage.setItem(key, JSON.stringify(next));
  } catch (e) {
    console.warn('saveRecent failed', e);
  }
}

/* Results render */
const cardsEl = $('#cards');
let rendered = 0;
const BATCH = 60;
let current = [];

function sorter(items) {
  const s = state.sort_by || 'quality';
  if (s === 'spacing_asc') return items.slice().sort((a, b) => (a.spacing_sum ?? 1e9) - (b.spacing_sum ?? 1e9));
  if (s === 'shape_desc') return items.slice().sort((a, b) => (b.shape_sum ?? -1) - (a.shape_sum ?? -1));
  if (s === 'age_asc')    return items.slice().sort((a, b) => (a.age ?? 1e9) - (b.age ?? 1e9));
  if (s === 'age_desc')   return items.slice().sort((a, b) => (b.age ?? -1) - (a.age ?? -1));
  if (s === 'id_asc')     return items.slice().sort((a, b) => idNum(a) - idNum(b));
  if (s === 'id_desc')    return items.slice().sort((a, b) => idNum(b) - idNum(a));
  return items.slice().sort(compareQuality);
}

/* æ§åˆ¶æ’åºä¸‹æ‹‰çš„é¡¯ç¤º/éš±è—ï¼ˆåªæœ‰ 1 ç­†æˆ– 0 ç­†å°±è—èµ·ä¾†ï¼‰ */
function updateSortVisibility() {
  const sel = document.getElementById('sortBy');
  if (!sel) return;

  const wrap = sel.closest('.sortWrap') || sel;
  const count = Array.isArray(lastFetched) ? lastFetched.length : 0;
  const enable = count > 1;

  if (!enable) {
    wrap.style.display = 'none';
    sel.disabled = true;
    // å›åˆ°é è¨­æ’åºï¼Œé¿å…é¡¯ç¤ºèª¤å°
    if (state.sort_by !== 'quality') state.sort_by = 'quality';
    if (sel.value !== 'quality') sel.value = 'quality';
  } else {
    wrap.style.display = '';
    sel.disabled = false;
  }
}


function makeCard(it) {
  const id = String(it.case_id || it['PanTS ID'] || it.id || '');
  const sex = it.sex || 'â€”';
  const age = Number.isFinite(it.age) ? `${it.age}y` : 'â€”';
  const tumor = (it.tumor === 1 ? 'Tumor' : (it.tumor === 0 ? 'No tumor' : 'â€”'));

  const thumbURL = (typeof profileURL === 'function' && typeof idNum === 'function')
    ? profileURL(idNum(it))
    : null;

  const wrap = document.createElement('article');
  wrap.className = 'card';
  wrap.innerHTML = `
    <img class="thumb" src="${thumbURL || svg('2D Image')}"
         onerror="this.src='${svg('2D Image')}'" alt="">
    <div class="body">
      <div class="titleRow">
        <a href="javascript:void(0)" class="caseLink" data-id="${id}">
          ${id.replace(/^Case\\s*/, '')}
        </a>
      </div>
      <div class="keyRow">
        <span class="kv"><span class="k">Sex</span><span class="v">${sex}</span></span>
        <span class="kv"><span class="k">Age</span><span class="v">${age}</span></span>
        <span class="kv"><span class="tag ${tumor === 'No tumor' ? 'ok' : 'bad'}">${tumor}</span></span>
      </div>
    </div>`;

  const open = () => { saveRecent(id); openViewer(id); };
  wrap.querySelector('.caseLink')?.addEventListener('click', open);
  wrap.querySelector('.thumb')?.addEventListener('click', open);

  return wrap;
}

function renderMore() {
  if (rendered >= current.length) return;
  const fr = document.createDocumentFragment();
  const end = Math.min(rendered + BATCH, current.length);
  for (let i = rendered; i < end; i++) fr.appendChild(makeCard(current[i]));
  cardsEl.appendChild(fr);
  rendered = end;
}

window.addEventListener('scroll', () => {
  const near = (window.innerHeight + window.scrollY) > (document.body.offsetHeight - 800);
  if (near) renderMore();
});

// === å…¨åŸŸæœå°‹ç‹€æ…‹ï¼ˆè‹¥å·²å­˜åœ¨å°±æ²¿ç”¨ï¼‰===
window.state = window.state || {
  q: '',
  sex: [],             // ['M','F'] ä¹‹ä¸€æˆ–å¤šé¸
  tumor: '',           // '' | '1' | '0'
  age_bin: [],         // ä¾‹å¦‚ ['20-29','30-39'] æˆ– ['UNKNOWN']
  age_from: '',        // è‡ªç”±è¼¸å…¥æ•¸å­—å­—ä¸²
  age_to: '',
  ct_phase: [],
  manufacturer: [],
  model: [],
  study_type: [],
  site_nat: [],
  year: [],
  sort_by: '',         // 'quality' ç­‰
  page: 1,
  per_page: 10000
};

// === æŠŠ state è½‰æˆæŸ¥è©¢å­—ä¸²ï¼Œä¾› facets / search ç”¨ ===
function qsFromState() {
  const p = new URLSearchParams();

  if (state.q) p.set('caseid', state.q);

  // sex å¤šé¸
  if (Array.isArray(state.sex) && state.sex.length) {
    state.sex.forEach(v => p.append('sex[]', v));
  }

  // tumor
  if (state.tumor !== '') p.set('tumor', state.tumor);

  // ageï¼šå„ªå…ˆ binsï¼Œå¦å‰‡ from/to
  if (Array.isArray(state.age_bin) && state.age_bin.length) {
    state.age_bin.forEach(v => p.append('age_bin[]', v));
  } else {
    if (state.age_from) p.set('age_from', state.age_from);
    if (state.age_to)   p.set('age_to',   state.age_to);
  }

  // é€²éš facets å¤šé¸
  ['ct_phase','manufacturer','model','study_type','site_nat','year']
    .forEach(k => (state[k] || []).forEach(v => p.append(k + '[]', v)));

  if (state.sort_by)  p.set('sort_by',  state.sort_by);
  if (state.page)     p.set('page',     String(state.page));
  if (state.per_page) p.set('per_page', String(state.per_page));

  return p.toString();
}

/* === Facet countsï¼šä¾ç›®å‰æ¢ä»¶å³æ™‚é‡ç®—ï¼ˆBooking é¢¨æ ¼ï¼‰=== */
let _facetTimer = null;
function refreshFacetsDebounced(delay = 120){
  clearTimeout(_facetTimer);
  _facetTimer = setTimeout(() => refreshFacets().catch(console.warn), delay);
}

async function refreshFacets() {
  const qs  = qsFromState(); // å¸¶ä¸Šç›®å‰æ‰€æœ‰æ¢ä»¶
  const url = '/api/facets?fields=ct_phase,manufacturer,model,study_type,site_nat,year&top_k=999&guarantee=0&' + qs;
  const f   = await fetchJSON(url);
  updateFacetCounts(f?.facets || {});
}


/* ---- æœå°‹åŸ·è¡Œï¼ˆçµ±ä¸€å…¥å£ï¼‰ ---- */
function triggerSearch() {
  const qBox = document.getElementById('q');
  state.q = (qBox?.value || '').trim();
  HAS_SEARCHED = true;
  // é—œæ‰å½ˆçª—
  document.getElementById('popID')?.classList.remove('open');
  document.getElementById('popSTA')?.classList.remove('open');
  run();
}
// ===== Recommended IDs =====
let ID_RECO = [];          // å¿«å–æ¨è–¦
let ID_RECO_AT = 0;        // æœ€è¿‘æŠ“å–æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰
const RECO_TTL = 60*1000;  // 1 åˆ†é˜å…§ä¸é‡æŠ“

function dedup(arr) {
  const seen = new Set(); const out = [];
  for (const x of arr) { const k = String(x); if (!seen.has(k)) { seen.add(k); out.push(k); } }
  return out;
}

// å–å‡ºæœ€è¿‘ç€è¦½
function getRecentIds() {
  try { return JSON.parse(localStorage.getItem('recentIds')||'[]'); } catch { return []; }
}

// ç”Ÿæˆ chip æŒ‰éˆ•
function makeIdChip(id) {
  const b = document.createElement('button');
  b.className = 'chip';
  b.textContent = id;
  b.addEventListener('click', () => {
    const q = document.getElementById('q');
    if (q) q.value = id;
    state.q = id;
    HAS_SEARCHED = true;
    run();
    document.getElementById('popID')?.classList.remove('open');
  });
  return b;
}

// ç¹ªè£½ã€Œæœ€è¿‘ç€è¦½ã€
function renderRecent() {
  const box = document.getElementById('idRecent');
  if (!box) return;
  const r = getRecentIds();
  box.innerHTML = '';
  if (!r.length) { box.innerHTML = '<span class="recMeta">No recent</span>'; return; }
  dedup(r).slice(0, 12).forEach(id => box.appendChild(makeIdChip(id)));
}

// æŠ“å–æ¨è–¦ï¼ˆæœ‰å¿«å–ï¼‰
async function fetchRecommended() {
  const now = Date.now();
  if (ID_RECO.length && (now - ID_RECO_AT) < RECO_TTL) return ID_RECO;

  try {
    // ä»¥ã€Œå“è³ªã€åšæ¨è–¦ï¼Œæœ€å¤š 12 ç­†ï¼›ä½ ä¹Ÿå¯ä»¥æ›æˆå…¶ä»–æ’åº
    const url = '/api/search?per_page=10000&sort_by=quality';
    const data = await fetchJSON(url);
    const items = Array.isArray(data?.items) ? data.items : [];
    ID_RECO = items
      .map(it => String(it.case_id || it['PanTS ID'] || it.id || ''))
      .filter(Boolean);
    ID_RECO_AT = now;
  } catch (e) {
    console.warn('fetchRecommended failed', e);
    ID_RECO = [];
  }
  return ID_RECO;
}

// ç¹ªè£½ã€ŒRecommended IDsã€
async function renderIdRecommendations() {
  const box = document.getElementById('idReco');
  if (!box) return;
  box.innerHTML = '<span class="recMeta">Loadingâ€¦</span>';

  // å…ˆæŠ“æ¨è–¦ï¼›æŠ“ä¸åˆ°å°±ç”¨æœ€è¿‘ç€è¦½é ‚ä¸Š
  let list = await fetchRecommended();
  if (!list || !list.length) list = getRecentIds();

  box.innerHTML = '';
  if (!list.length) {
    box.innerHTML = '<span class="recMeta">No suggestions</span>';
    return;
  }
  dedup(list).slice(0, 12).forEach(id => box.appendChild(makeIdChip(id)));
}

// ===== äº‹ä»¶ï¼šé–‹å•Ÿå½ˆçª—æ™‚é‡æ–°æ¸²æŸ“ =====
(function bindIdPop() {
  const wrap = document.getElementById('popID');
  const input = document.getElementById('q');
  if (!wrap || !input) return;

  // æ‰“é–‹å½ˆçª—
  const open = async () => {
    wrap.classList.add('open');
    await renderIdRecommendations();
    renderRecent();
  };
  // é—œé–‰å½ˆçª—
  const close = () => wrap.classList.remove('open');

  // èšç„¦/é»æ“Šæ‰“é–‹ï¼ŒæŒ‰ Esc é—œé–‰
  input.addEventListener('focus', open);
  input.addEventListener('click', open);
  input.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });

  // é»æ“Šå¤–é¢å€åŸŸå°±é—œé–‰
  document.addEventListener('click', (e) => {
    if (!wrap.contains(e.target)) close();
  });
})();
/* ---- Search æŒ‰éˆ• ---- */
document.getElementById('searchBtn')?.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  // çµ±ä¸€èµ°ä¸»æµç¨‹ï¼Œé¿å…é‡è¤‡è«‹æ±‚ & æ•¸å­—é–ƒçˆ
  triggerSearch();
});

/* ---- åœ¨è¼¸å…¥æ¡†æŒ‰ Enter æœå°‹ã€æŒ‰ Esc æ¸…ç©ºä¸¦æœå°‹å…¨éƒ¨ ---- */

const qInput = document.getElementById('q');
qInput?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    triggerSearch();
  } else if (e.key === 'Escape') {
    qInput.value = '';
    triggerSearch(); // ç©ºå­—ä¸² â†’ æœå°‹å…¨éƒ¨
  }
});


/* ---- Search run ---- */
async function run() {
  // 1) åŒæ­¥æŸ¥è©¢å­—ä¸²
  const qBox  = document.getElementById('q');
  const query = (qBox?.value || '').trim();
  state.q = query;

  // 2) å…ˆåˆ·æ–° facetsï¼ˆç…§ä½ åŸæµç¨‹ï¼‰
  await refreshFacets();

  // 3) æ‰“ç¬¬ä¸€æ¬¡ /api/search
  const p = new URLSearchParams(qsFromState());
  p.set('per_page', '10000');
  let data = await fetchJSON('/api/search?' + p.toString());
  lastFetched = (data.items || []).filter(Boolean);

  // 4) åƒ…åœ¨ã€Œæ²’æœ‰ä»»ä½•æ¢ä»¶ä¸” 0 ç­†ã€æ™‚æ‰ fallback æŠ“å…¨é‡
  const hasAnyFilter = (() => {
    const arrLen = k => Array.isArray(state[k]) ? state[k].length : 0;
    return !!(state.q ||
      arrLen('sex') || state.tumor !== '' ||
      state.age_from || state.age_to || arrLen('age_bin') ||
      arrLen('ct_phase') || arrLen('manufacturer') || arrLen('model') ||
      arrLen('study_type') || arrLen('site_nat') || arrLen('year'));
  })();

  if (!hasAnyFilter && query === '' && lastFetched.length === 0) {
    data = await fetchJSON('/api/search?per_page=10000&sort_by=id');
    lastFetched = (data.items || []).filter(Boolean);
  }

  // 5) å‰ç«¯è‡ªè¨‚éæ¿¾ï¼ˆä¿ç•™ä½ çš„åŸæœ¬é‚è¼¯ï¼‰
  const norm = s => String(s ?? '').trim().toLowerCase();
  lastFetched = lastFetched.filter(it => {
    const hasAll = (selected, value) => selected.length === 0 || selected.some(v => norm(v) === norm(value));
    const overlap = (selected, tokens) => {
      if (selected.length === 0) return true;
      const sel = selected.map(norm);
      return tokens.some(t => sel.includes(norm(t)));
    };
    const model = pickField(it, ['manufacturer model', 'Manufacturer model', 'model', 'Model']);
    if (!hasAll(state.model, model)) return false;

    const types = splitTokens(pickField(it, ['study type', 'Study type', 'study_type', 'type', 'Type']));
    const nats  = splitTokens(pickField(it, ['site nationality', 'Site nationality', 'site_nat', 'nationality', 'country', 'Country']), mapNat);
    const year  = pickField(it, ['study year', 'Study year', 'year', 'study_year', 'Year']);

    return overlap(state.study_type, types) &&
           overlap(state.site_nat, nats) &&
           hasAll(state.year, year);
  });

  // 6) ä»¥ã€Œå‰ç«¯å¯è¦‹æ•¸ã€ç‚ºæº–è¦†å¯« LAST_TOTALï¼Œé¿å… 9901
  window.LAST_TOTAL = lastFetched.length;

  // 7) æ›´æ–° UI + æ¸²æŸ“
  HAS_SEARCHED = true;           // ç¢ºä¿é¡¯ç¤ºçµæœå€
  updatePanels();
  renderAfterFetch(lastFetched);
}

/* =========================
   STA / Recent + Age å¤šé¸
   ========================= */
// --- Ageï¼šå¤šé¸ + Unknownï¼ˆå¤–è§€æ”¹æˆèˆ‡ Tumor ä¸€è‡´çš„å¹³é¢ pillï¼‰ ---
function renderAgeChips(list) {
  const w = $('#ageChips');
  if (!w) return;

  // ç¢ºä¿å¤–è§€ class å­˜åœ¨ï¼ˆå¹³é¢ã€ä¸åƒæŒ‰éˆ•ï¼‰
  w.classList.add('chipArea', 'flat');
  w.innerHTML = '';

  const bins = Array.isArray(list) && list.length
    ? list.slice()
    : ['0-9','10-19','20-29','30-39','40-49','50-59','60-69','70-79','80-89','90-99'];

  // Any
  const anyBtn = document.createElement('button');
  anyBtn.className = 'chip';
  anyBtn.id = 'ageAny';
  anyBtn.textContent = 'Any';       // â† åŸæœ¬æ˜¯ "Any age"
  anyBtn.addEventListener('click', () => {
    state.age_bin = [];
    state.age_from = '';
    state.age_to = '';
    $$('#ageChips .chip').forEach(x => x.classList.remove('active'));
    anyBtn.classList.add('active');
    updateSTASummary();
    // ä¸ auto-searchï¼›æŒ‰ä¸‹ Search æ‰æŸ¥
  });
  w.appendChild(anyBtn);

  // binsï¼ˆå¤šé¸ï¼‰
  bins.forEach(label => {
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.textContent = label;
    btn.dataset.bin = label;
    btn.addEventListener('click', () => {
      const bin = btn.dataset.bin;
      const i = state.age_bin.indexOf(bin);
      if (i === -1) state.age_bin.push(bin); else state.age_bin.splice(i, 1);
      btn.classList.toggle('active');
      const any = $('#ageAny');
      if (any) any.classList.toggle('active', state.age_bin.length === 0);
      // é¸äº† bins å°±æ¸… from/to
      state.age_from = '';
      state.age_to = '';
      updateSTASummary();
      // ä¸ auto-searchï¼›æŒ‰ä¸‹ Search æ‰æŸ¥
    });
    w.appendChild(btn);
  });

  // Unknown
  const unk = document.createElement('button');
  unk.className = 'chip';
  unk.textContent = 'Unknown';
  unk.dataset.bin = 'UNKNOWN';
  unk.addEventListener('click', () => {
    const bin = 'UNKNOWN';
    const i = state.age_bin.indexOf(bin);
    if (i === -1) state.age_bin.push(bin); else state.age_bin.splice(i, 1);
    unk.classList.toggle('active');
    const any = $('#ageAny');
    if (any) any.classList.toggle('active', state.age_bin.length === 0);
    state.age_from = '';
    state.age_to = '';
    updateSTASummary();
    // ä¸ auto-searchï¼›æŒ‰ä¸‹ Search æ‰æŸ¥
  });
  w.appendChild(unk);

  // åˆå§‹ active
  if (Array.isArray(state.age_bin) && state.age_bin.length) {
    state.age_bin.forEach(b => {
      const btn = $(`#ageChips .chip[data-bin="${CSS.escape(b)}"]`);
      if (btn) btn.classList.add('active');
    });
  } else {
    anyBtn.classList.add('active');
  }
}



/* ===== Viewer ===== */
function showPreparing(on) {
  $('#prepPage').classList.toggle('show', !!on);
  $('#prepPage').setAttribute('aria-hidden', on ? 'false' : 'true');
}

function openViewer(id) {
  showPreparing(true);

  // æ¨™è¨˜ viewer æ¨¡å¼ï¼ˆæœƒè§¸ç™¼ body.viewer-open .hero éš±è—ï¼‰
  document.body.style.overflow = 'hidden';
  document.body.classList.add('viewer-open');

  const v = $('#viewer');
  v.classList.add('compact');
  v.setAttribute('aria-hidden', 'false');

  // åˆå§‹æ–‡å­—/å ä½
  $('#vCard').style.display = 'none';
  $('#vSidebar').style.display = 'none';
  $('#caseTitle').textContent = 'Case ID: ' + id;
  $('#axial').src = vsvg('2D Axial');
  $('#sagittal').src = vsvg('2D Sagittal');
  $('#coronal').src = vsvg('2D Coronal');

  // è®“ viewer ä¸€å®šåœ¨æœ€ä¸Šé¢
  v.style.position = 'fixed';
  v.style.inset = '0';
  v.style.zIndex = '10000';

  setTimeout(() => {
    showPreparing(false);
    v.classList.add('show');
    $('#prep')?.classList.add('hidden');

    // æ›´æ–°ç¶²å€
    const u = new URL(location.href);
    u.searchParams.set('case', id);
    history.replaceState({}, '', u);
  }, 700);
}
document.activeElement?.blur();  // ç§»é™¤ç•¶å‰ç„¦é»ï¼Œé¿å… aria-hidden è­¦å‘Š
document.getElementById('viewer').setAttribute('aria-hidden', 'true');

function closeViewer() {
  const v = $('#viewer');
  v.classList.remove('show');
  v.setAttribute('aria-hidden', 'true');

  // é‚„åŸæ²å‹•èˆ‡ viewer æ¨™è¨˜ â†’ æœå°‹åˆ—æœƒè‡ªå‹•å›ä¾†
  document.body.style.overflow = '';
  document.body.classList.remove('viewer-open');

  // æ¸…æ‰ URL åƒæ•¸
  const u = new URL(location.href);
  u.searchParams.delete('case');
  history.replaceState({}, '', u);
}

$('#btnBack').addEventListener('click', closeViewer);

const CLASS_MAP = [
  { name: 'Vascular System', key: 'vascular', items: [['aorta'], ['celiac_artery'], ['superior_mesenteric_artery'], ['postcava'], ['veins']] },
  { name: 'Digestive System', key: 'digestive', items: [['Pancreas'], ['colon'], ['duodenum'], ['stomach'], ['liver'], ['common_bile_duct'], ['gall_bladder']] },
  { name: 'Endocrine System', key: 'endocrine', items: [['adrenal_gland_left'], ['adrenal_gland_right']] },
  { name: 'Urinary System', key: 'urinary', items: [['Kidneys'], ['bladder']] },
  { name: 'Skeletal System', key: 'skeletal', items: [['femur_left'], ['femur_right']] },
  { name: 'Lymphatic System', key: 'lymphatic', items: [['spleen']] },
  { name: 'Reproductive System', key: 'reproductive', items: [['prostate']] },
  { name: 'Respiratory System', key: 'respiratory', items: [['lung_left'], ['lung_right']] }
];


function renderClassMap() {
  const root = document.getElementById('cmRoot'); if (!root) return; root.innerHTML = '';
  CLASS_MAP.forEach(grp => {
    const box = document.createElement('section'); box.className = 'cm-group';
    const row = document.createElement('div'); row.className = 'cm-row';
    row.innerHTML = `<span class="chev" aria-hidden="true">â–¾</span><span class="title">${grp.name}</span><input type="checkbox" class="grpCheck" checked aria-label="Toggle ${grp.name}">`;
    const items = document.createElement('div'); items.className = 'cm-items';
    grp.items.forEach(([label]) => {
      const id = `cm_${grp.key}_${label}`.replace(/\W+/g, '_').toLowerCase();
      const r = document.createElement('label'); r.className = 'cm-item';
      r.innerHTML = `<input type="checkbox" class="itemCheck" id="${id}" data-group="${grp.key}" data-name="${label}" checked><span class="name">${label.replace(/_/g, ' ')}</span>`;
      items.appendChild(r);
    });
    let open = true; const chev = row.querySelector('.chev');
    const setOpen = (on) => { open = on; box.classList.toggle('closed', !on); chev.textContent = on ? 'â–¾' : 'â–¸'; };
    row.addEventListener('click', (e) => { const t = e.target; if (t && t.classList && t.classList.contains('grpCheck')) return; setOpen(!open); });
    setOpen(true);
    const grpCheck = row.querySelector('input.grpCheck');
    if (grpCheck) { grpCheck.addEventListener('change', () => { const checked = grpCheck.checked; items.querySelectorAll('input.itemCheck').forEach(c => { c.checked = checked; }); }); }
    box.appendChild(row); box.appendChild(items); root.appendChild(box);
  });
  const btn = document.getElementById('toggleAll');
  if (btn) {
    btn.onclick = () => {
      const boxes = Array.from(document.querySelectorAll('.cm-group .grpCheck'));
      const turnOff = boxes.length && boxes.every(b => b.checked);
      boxes.forEach(b => b.checked = !turnOff);
      document.querySelectorAll('.cm-group .itemCheck').forEach(c => c.checked = !turnOff);
    };
  }
}

// settings / classmap toggle
document.getElementById('btnGear')?.addEventListener('click', () => {
  const card = $('#vCard'), side = $('#vSidebar'); if (!card || !side) return;
  side.style.display = 'none';
  card.style.display = (getComputedStyle(card).display === 'none') ? 'block' : 'none';
});
document.getElementById('openClassMap')?.addEventListener('click', () => {
  const side = $('#vSidebar'), card = $('#vCard'); if (!side || !card) return;
  card.style.display = 'none';
  if (getComputedStyle(side).display === 'none') { renderClassMap(); side.style.display = 'block'; }
  else { side.style.display = 'none'; }
});

['op', 'lvl', 'win'].forEach(id => { const r = $('#' + id), lab = $('#' + id + 'v'); r?.addEventListener('input', () => { if (lab) lab.textContent = r.value; }); });
$('#zoomIn').innerHTML = '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M11 4v7H4v2h7v7h2v-7h7v-2h-7V4z"/></svg>';
$('#zoomOut').innerHTML = '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M4 11v2h16v-2z"/></svg>';
$('#download').innerHTML = '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3v10l3.5-3.5 1.4 1.4L12 16.8 7.1 10.9l1.4-1.4L11 13V3zM4 19v2h16v-2H4z"/></svg>';
$('#report').innerHTML = '<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h8l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm7 1.5V8h3.5L14 4.5zM8 11h8v2H8v-2zm0 4h8v2H8v-2z"/></svg>';
let Z = 1; function applyZoom() { $$('.v-view img').forEach(img => { img.style.transformOrigin = 'center center'; img.style.transform = `scale(${Z})`; }); }
$('#zoomIn')?.addEventListener('click', () => { Z = Math.min(3, Z + 0.2); applyZoom(); });
$('#zoomOut')?.addEventListener('click', () => { Z = Math.max(1, Z - 0.2); applyZoom(); });

const rpModal = $('#reportModal');
$('#download')?.addEventListener('click', () => {
  ['axial', 'sagittal', 'coronal'].forEach(id => {
    const img = document.getElementById(id);
    if (!img || !img.src) return;
    const a = document.createElement('a');
    a.href = img.src;
    a.download = `case-${(document.getElementById('caseTitle')?.textContent || 'id').replace(/\D+/g, '')}-${id}.png`;
    document.body.appendChild(a); a.click(); a.remove();
  });
});
$('#report')?.addEventListener('click', () => rpModal?.classList.add('show'));
$('#rpClose')?.addEventListener('click', () => rpModal?.classList.remove('show'));
rpModal?.addEventListener('click', e => { if (e.target === rpModal) rpModal.classList.remove('show'); });

// deeplink
(() => { const u = new URL(location.href); const id = u.searchParams.get('case'); if (id) openViewer(id); })();

/* ---- Recent render ---- */
function renderRecent() {
  const box = $('#idRecent');
  if (!box) return;

  const r = JSON.parse(localStorage.getItem('recentIds') || '[]');
  box.innerHTML = '';

  if (!r.length) {
    box.innerHTML = '<span class="recMeta">No recent</span>';
    return;
  }

  r.forEach(id => {
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = id;
    b.addEventListener('click', () => {
      $('#q').value = id;
      state.q = id;
      HAS_SEARCHED = true;
      run();
      $('#popID')?.classList.remove('open');
    });
    box.appendChild(b);
  });
}

/* ---- STA Summary ---- */
function updateSTASummary() {
  const tumor =
    state.tumor === '' ? 'Any tumor' :
    state.tumor === '1' ? 'Tumor' : 'No tumor';

  const toArray = v => Array.isArray(v) ? v : (v ? [String(v)] : []);
  const selSex = toArray(state.sex);
  const mapSex = s => (s === 'M' ? 'Male' : s === 'F' ? 'Female' : 'Unknown');
  const sexLabel = selSex.length ? selSex.map(mapSex).join('/') : 'Any sex';

  let ageLabel = 'Any age';
  if (Array.isArray(state.age_bin) && state.age_bin.length) {
    const bins = state.age_bin.slice();
    const onlyUnknown = bins.length === 1 && bins[0] === 'UNKNOWN';
    if (onlyUnknown) {
      ageLabel = 'UNKNOWN';
    } else {
      const shown = bins.filter(b => b !== 'UNKNOWN').slice(0, 3).join(', ');
      const more = bins.filter(b => b !== 'UNKNOWN').length > 3
        ? ` +${bins.filter(b => b !== 'UNKNOWN').length - 3}` : '';
      ageLabel = shown ? (shown + more) : 'UNKNOWN';
    }
  }
  const sta = document.getElementById('staSummary');
  if (sta) sta.textContent = `${tumor} Â· ${sexLabel} Â· ${ageLabel}`;
}

/* ---- Search / Sex / Tumor / Sort ---- */
// Search button
(() => {
  const btn = document.getElementById('searchBtn');
  if (!btn) return;
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    HAS_SEARCHED = true;
    run();
    document.getElementById('popID')?.classList.remove('open');
    document.getElementById('popSTA')?.classList.remove('open');
  });
})();

// Sex multi
(() => {
  const box = document.getElementById('sexChips');
  if (!box) return;
  box.addEventListener('click', (e) => {
    const b = e.target.closest('.chip');
    if (!b) return;
    e.stopPropagation();
    const val = b.dataset.sex ?? '';
    if (!Array.isArray(state.sex)) state.sex = state.sex ? [String(state.sex)] : [];
    if (val === '') {
      state.sex = [];
      $$('#sexChips .chip').forEach(x => x.classList.remove('active'));
      $$('#sexChips .chip[data-sex=""]').forEach(x => x.classList.add('active'));
    } else {
      b.classList.toggle('active');
      const i = state.sex.indexOf(val);
      if (i === -1) state.sex.push(val); else state.sex.splice(i, 1);
      const anyBtn = $$('#sexChips .chip[data-sex=""]')[0];
      if (anyBtn) anyBtn.classList.toggle('active', state.sex.length === 0);
    }
    updateSTASummary();
  });
})();

// Tumor single
(() => {
  const box = document.getElementById('tumorChips');
  if (!box) return;
  box.addEventListener('click', (e) => {
    const b = e.target.closest('.chip');
    if (!b) return;
    e.stopPropagation();
    state.tumor = b.dataset.tumor ?? '';
    $$('#tumorChips .chip').forEach(x =>
      x.classList.toggle('active', (x.dataset.tumor ?? '') === state.tumor)
    );
    updateSTASummary();
  });
})();

// Sort select
(() => {
  const sortSel = document.getElementById('sortBy');
  if (!sortSel) return;
  sortSel.addEventListener('change', () => {
    state.sort_by = sortSel.value || 'quality';
    if (HAS_SEARCHED) renderAfterFetch(lastFetched || []);
  });
})();

// æ‹‰ä¸€æ¬¡å®Œæ•´æ¸…å–®åˆ° ALL_ITEMSï¼ˆçµ¦ Browse / å¾Œå‚™ç”¨ï¼‰
async function bootstrapLists(){
  try{
    const data = await fetch('/api/search?per_page=10000&sort_by=id', {cache:'no-store'})
                  .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); });
    ALL_ITEMS = data.items || [];
  }catch(e){
    console.warn('bootstrapLists failed:', e);
    ALL_ITEMS = [];
  }
}

/* ---- åˆå§‹åŒ– ---- */
(async function init() {
  // æœ‰å°±å‘¼å«ï¼›é¿å…ç¼ºå‡½å¼æ™‚ä¸­æ–·
  try { renderRecent?.(); } catch(e){ console.warn('renderRecent failed:', e); }

  if (typeof bootstrapLists === 'function') {
    await bootstrapLists();
  } else {
    console.warn('bootstrapLists is not defined; skipping preload');
  }

  // Age åˆå§‹ chips
  state.age_bin = [];
  renderAgeChips();

  // Browse å€å¡Š
  try { await initBrowse?.(); } catch(e){ console.warn('initBrowse failed:', e); }

  // STA chips åˆå§‹ç‹€æ…‹
  $$('#sexChips .chip').forEach(x => x.classList.toggle('active', (x.dataset.sex ?? '') === ''));
  $$('#tumorChips .chip').forEach(x => x.classList.toggle('active', (x.dataset.tumor ?? '') === ''));

  updateSTASummary?.();
  HAS_SEARCHED = false;
  lastFetched = [];
  updatePanels?.();
})();

// é¦–é è¼‰å…¥å…ˆæŠŠçµæœé¢æ¿è—èµ·ä¾†
document.addEventListener('DOMContentLoaded', () => {
  const resultsPanel = document.getElementById('resultsPanel');
  const head = document.querySelector('.resultsHead');
  const cards = document.getElementById('cards');

  if (resultsPanel) resultsPanel.style.display = 'none';
  if (head) head.style.display = 'none';
  if (cards) cards.style.display = 'none';

  try {
    updatePanels();
  } catch (e) {
    console.warn(e);
  }
});

// ===== helpers for infinite render =====
// æ‡¶è¼‰åœ– + ä½µç™¼é™æµï¼ˆé¿å… 429ï¼‰
// âœ… åªä¿ç•™ã€Œè¦–çª—ã€ç‚º viewport çš„å®šç¾©ï¼ˆåˆªæ‰èˆŠçš„ #resultsPanel ç‰ˆæœ¬ï¼‰
const IMG_VIEWPORT = () => null;

const MAX_IMG_CONC = 6;
let _imgInFlight = 0;
const _imgQueue = [];

// åœ–ç‰‡ IntersectionObserverï¼šåªåœ¨æ¥è¿‘å¯è¦–ç¯„åœæ™‚æ‰æ’å…¥ä¸‹è¼‰
const ioImg = new IntersectionObserver((entries) => {
  entries.forEach(e => {
    if (!e.isIntersecting) return;
    const img = e.target;
    ioImg.unobserve(img);
    _enqueueImgLoad(img);
  });
}, { root: IMG_VIEWPORT(), rootMargin: '400px' });

function attachLazy(imgEl, url){
  imgEl.loading = 'lazy';
  imgEl.decoding = 'async';
  imgEl.dataset.src = url;
  imgEl.src = svg('2D Image'); // ä½ çš„ placeholder
  ioImg.observe(imgEl);
}

function _enqueueImgLoad(img){
  _imgQueue.push({ img, attempt: 0 });
  _pumpImgQueue();
}

function _pumpImgQueue(){
  while (_imgInFlight < MAX_IMG_CONC && _imgQueue.length){
    const job = _imgQueue.shift();
    _imgInFlight++;
    _loadWithRetry(job.img, job.attempt).finally(() => {
      _imgInFlight--;
      _pumpImgQueue();
    });
  }
}

function _loadWithRetry(img, attempt = 0){
  const url = img.dataset.src;
  if (!url) return Promise.resolve();
  return new Promise((resolve) => {
    const fail = () => {
      if (attempt < 3){
        const wait = 500 * Math.pow(2, attempt); // 0.5s,1s,2s
        setTimeout(() => _loadWithRetry(img, attempt + 1).then(resolve), wait);
      } else {
        img.src = svg('2D Image');
        resolve();
      }
    };
    img.onerror = fail;
    img.onload  = () => resolve();
    img.src = url; // çœŸæ­£ç™¼è«‹æ±‚
  });
}

// åˆ†æ‰¹æ›è¼‰ï¼ˆé˜²æ­¢é‡è¤‡å®£å‘Šï¼‰
window.BATCH     = window.BATCH     ?? 60;  // æ¯æ‰¹å¹¾å¼µå¡
window._mountIdx = window._mountIdx ?? 0;
window._infIO    = window._infIO    ?? null;

function _fallbackCard(item){
  const el = document.createElement('article');
  el.className = 'card';
  el.innerHTML = `
    <img class="thumb" alt="">
    <div class="body">
      <div class="titleRow">
        <a href="javascript:void(0)" class="caseLink">${String(item.case_id || item.id || '')}</a>
      </div>
      <div class="keyRow">
        <span class="kv"><span class="k">Sex</span><span class="v">${String(item.sex ?? 'â€”')}</span></span>
        <span class="kv"><span class="k">Age</span><span class="v">${Number.isFinite(item.age) ? item.age + 'y' : 'â€”'}</span></span>
        <span class="kv"><span class="tag ${item.tumor === 1 ? 'bad' : 'ok'}">${item.tumor === 1 ? 'Tumor' : 'No tumor'}</span></span>
      </div>
    </div>`;
  return el;
}

// å…è¨±æŒ‡å®šæœ¬æ‰¹æ›å¤šå°‘å¼µï¼›ä¸çµ¦å°±ç”¨åŸæœ¬çš„ BATCH
function _appendBatch(cards, items, limit = BATCH){
  const end = Math.min(_mountIdx + limit, items.length);
  const frag = document.createDocumentFragment();
  for (let i = _mountIdx; i < end; i++){
    const it = items[i];
    const el = (typeof makeCard === 'function') ? makeCard(it)
            : (typeof makeCardHTML === 'function') ? (() => {
                const a = document.createElement('article');
                a.className = 'card';
                a.innerHTML = makeCardHTML(it);
                return a;
              })()
            : _fallbackCard(it);

    const img = el.querySelector('img.thumb');
    if (img) {
      const id = extractNumFromId(it.case_id || it.id);
      attachLazy(img, profileURL(id));
    }
    frag.appendChild(el);
  }
  cards.appendChild(frag);
  _mountIdx = end;
}

function _setupInfinite(cards, items){
  // æ¸…æ‰èˆŠ sentinel
  const old = cards.querySelector('[data-sentinel]');
  if (old) old.remove();

  // ç¢ºä¿å®¹å™¨å¯åšçµ•å°å®šä½åƒè€ƒ
  if (getComputedStyle(cards).position === 'static') {
    cards.style.position = 'relative';
  }

  const sentinel = document.createElement('div');
  sentinel.setAttribute('data-sentinel', '1');

  // âœ… ç”¨çµ•å°å®šä½ï¼Œå®Œå…¨ä¸ä½” CSS Grid çš„æ ¼å­
  Object.assign(sentinel.style, {
    position: 'absolute',
    left: '0',
    bottom: '0',
    width: '1px',
    height: '1px',
    overflow: 'hidden',
    pointerEvents: 'none',
    // ä¸‹é¢å…©è¡Œåªæ˜¯ä¿éšªï¼Œç¢ºä¿å®ƒä¸å½±éŸ¿æ’ç‰ˆ
    transform: 'translateZ(0)',
    contain: 'layout style'
  });
  cards.appendChild(sentinel);

  // é‡æ–°æ› observer
  if (_infIO) { try { _infIO.disconnect(); } catch(e){} }
  _infIO = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (!e.isIntersecting) return;

      let loops = 0, MAX_LOOPS = 5;
      const nearBottom = () => sentinel.getBoundingClientRect().top < (innerHeight + 1200);

      while (_mountIdx < items.length && nearBottom() && loops < MAX_LOOPS) {
        _appendBatch(cards, items);
        loops++;
      }
      if (_mountIdx < items.length && nearBottom()) {
        requestAnimationFrame(() => { _infIO.unobserve(sentinel); _infIO.observe(sentinel); });
      }
      if (_mountIdx >= items.length) _infIO.disconnect();
    });
  }, { root: null, rootMargin: '1200px', threshold: 0 });

  _infIO.observe(sentinel);
}


function _startInfiniteRender(cards, items){
  // æ¸…ç©ºä¸¦é‡ç½®æ¸¸æ¨™
  cards.innerHTML = '';
  _mountIdx = 0;

  // èµ·æ‰‹å…ˆæ›å…©æ‰¹ï¼ˆå¤§ç´„ 120 å¼µï¼‰ï¼Œç•«é¢ä¸ç©º
  _appendBatch(cards, items); // ç¬¬ 1 æ‰¹
  _appendBatch(cards, items); // ç¬¬ 2 æ‰¹

  // å•Ÿå‹•ç„¡é™æ²å‹•ï¼šsentinel è¿‘è¦–çª—åº•æ™‚ç¹¼çºŒè£œæ‰¹
  _setupInfinite(cards, items);

  // è‹¥å…§å®¹é«˜åº¦å¤ªçŸ­ï¼Œä¸»å‹•è£œåˆ° sentinel æ¨å‡ºè¦–çª—åº•ç·£ï¼ˆé¿å…å¡åœ¨ 120ï¼‰
  setTimeout(() => {
    const sentinel = cards.querySelector('[data-sentinel]');
    if (!sentinel) return;
    while (sentinel.getBoundingClientRect().bottom < window.innerHeight + 200 &&
           _mountIdx < items.length) {
      _appendBatch(cards, items);
    }
  }, 0);
}


// ===== end helpers =====

function renderAfterFetch(items = []) {
  const cardsEl = document.getElementById('cards');
  const resultsPanel = document.getElementById('resultsPanel');
  const head = document.querySelector('.resultsHead');
  const recBar = document.querySelector('#recBar');
  if (!cardsEl) return;

  const list = Array.isArray(items) ? items : [];
  window.lastFetched = list;
  const n = list.length;

  // 0 ç­†ï¼šçµæœæ¨™é¡Œèˆ‡é¢æ¿ä¿ç•™ï¼Œå¡ç‰‡éš±è—ï¼ŒBrowse é¡¯ç¤º
  if (n === 0) {
    const total = 0;
    if (typeof setResultsCount === 'function') setResultsCount(total);
    else {
      const counterEl = document.getElementById('counter') || document.querySelector('.counter');
      if (counterEl) counterEl.textContent = 'Results: 0 cases';
    }

    head && (head.style.display = '');
    resultsPanel && (resultsPanel.style.display = '');
    if (cardsEl) { cardsEl.style.display = 'none'; cardsEl.innerHTML = ''; }
    recBar && recBar.style.removeProperty('display');
    return;
  }

  // æœ‰çµæœï¼šæ­£å¸¸é¡¯ç¤º
  recBar && (recBar.style.display = 'none');
  head && (head.style.display = '');
  resultsPanel && (resultsPanel.style.display = '');
  cardsEl.style.display = '';

  const total = Number(window.LAST_TOTAL ?? n) || n;
  if (typeof setResultsCount === 'function') setResultsCount(total);
  else {
    const counterEl = document.getElementById('counter') || document.querySelector('.counter');
    if (counterEl) counterEl.textContent = `Results: ${total} ${total === 1 ? 'case' : 'cases'}`;
  }

  cardsEl.classList.toggle('centerOne', n === 1);
  head?.classList.toggle('single', n === 1);
  resultsPanel?.classList.toggle('single', n === 1);

  const sorted = (typeof sorter === 'function') ? sorter(list.slice()) : list.slice();
  _startInfiniteRender(cardsEl, sorted);

  const sortSel = document.getElementById('sortBy');
  if (sortSel) {
    const disabled = n < 2;
    sortSel.disabled = disabled;
    sortSel.parentElement?.classList?.toggle('disabled', disabled);
  }
}

// é˜²æ­¢æ‹–ç§»é€ æˆé¸å–
['#recPrev', '#recNext', '#recPlay'].forEach(sel => {
  const btn = document.querySelector(sel);
  if (btn) btn.addEventListener('mousedown', e => e.preventDefault());
});

   

</script>

<script>
document.getElementById('homeBtn')?.addEventListener('click', () => {
  // âœ… å›åˆ°é¦–é ï¼ˆé‡æ–°è¼‰å…¥æ•´å€‹ç•«é¢ï¼‰
  location.reload();
});
(() => {
  const qInput = document.getElementById('q');
  const clearBtn = document.getElementById('clearBtn');
  if (!qInput || !clearBtn) return; // ä¿è­·æ©Ÿåˆ¶ï¼Œé˜²æ­¢å ±éŒ¯

  clearBtn.addEventListener('click', () => {
    qInput.value = '';
    qInput.focus();

    // è‹¥å¸Œæœ›æ¸…é™¤æ™‚å›é¦–é  (å¯é¸)
    window.HAS_SEARCHED = false;
    if (typeof loadRandom === 'function') loadRandom();
  });
})();
</script>


</body>

</html>
